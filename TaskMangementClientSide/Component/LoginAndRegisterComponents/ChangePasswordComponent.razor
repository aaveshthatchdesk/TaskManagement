@using Task.Application.DTOs
@inject HttpClient Http
@inject NavigationManager nav
@inject IJSRuntime JS

<style>
    .btn-outline-dark {
        background-color: #2c3e50 !important;
        color: white !important;
    }

        .btn-outline-dark:hover {
            background-color: #0d6efd !important;
            color: white !important;
        }

    .role-badge {
        display: inline-block;
        background: #f0f0f0;
        padding: 6px 18px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 15px;
    }

    .fade-message {
        animation: fadeOut 1.5s forwards;
    }
    @@keyframes fadeOut {
        0%

    {
        opacity: 1;
    }

    100% {
        opacity: 0;
    }

    }
</style>


<div class="d-flex justify-content-center align-items-center vh-100 bg-light">
    <div class="card p-5 shadow-lg border-0 rounded-4" style="max-width: 400px; width: 100%">

        <!-- Title & Logo -->
        <div class="text-center mb-4">
            <img src="images/TaskMa.png" alt="Logo" width="90"
                 class="mb-3 rounded-circle shadow-sm" />
            <h4 class="fw-bold" style="color:#2c3e50;">Change Password</h4>
            <div class="role-badge">Security Update Required</div>
            <p class="text-muted small mb-0">Please update your password to continue</p>
        </div>

        <!-- Change Password Form -->
        <EditForm Model="@Model" OnValidSubmit="SubmitForm">
            <DataAnnotationsValidator />

            <!-- Old Password -->
            <div class="mb-3">
                <label class="form-label fw-semibold">Old Password <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-lock-fill"></i></span>
                    <InputText type="password" class="form-control" @bind-Value="Model.OldPassword" placeholder="Enter old password" />
                </div>
                <ValidationMessage For="@(() => Model.OldPassword)" class="text-danger small" />
            </div>

            <!-- New Password -->
            <div class="mb-3">
                <label class="form-label fw-semibold">New Password <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-shield-lock"></i></span>
                    <InputText type="password" class="form-control" @bind-Value="Model.NewPassword" placeholder="Enter new password" />
                </div>
                <ValidationMessage For="@(() => Model.NewPassword)" class="text-danger small" />
            </div>


            <div class="mb-3">
                <label class="form-label fw-semibold">Confirm Password <span class="text-danger">*</span></label>
                <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-shield-lock"></i></span>
                    <InputText type="password" class="form-control" @bind-Value="Model.ConfirmPassword" placeholder="Enter new password again" />
                </div>
                <ValidationMessage For="@(() => Model.ConfirmPassword)" class="text-danger small" />
            </div>

            <button class="btn btn-outline-dark w-100 py-2 fw-semibold" type="submit">
                <i class="bi bi-check2-circle me-2"></i>Update Password
            </button>
        </EditForm>

        <!-- Message -->
        @if (!string.IsNullOrEmpty(Message))
        {
            <div class="alert alert-info mt-3 text-center fade-message">@Message</div>
        }
    </div>
</div>

@code {

    [Parameter] public int UserId { get; set; }

    public ChangePasswordDto Model { get; set; } = new();
    public string? Message { get; set; }

    protected override void OnInitialized()
    {
        Model.UserId = UserId;
    }

    private async Task SubmitForm()
    {
        var response = await Http.PostAsJsonAsync("api/Auth/change-password", Model);

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<Dictionary<string, string>>();
            string? role = null;

            if (result != null)
            {
                if (result.ContainsKey("Role"))
                    role = result["Role"];
                else if (result.ContainsKey("role"))
                    role = result["role"];
                else if (result.ContainsKey("UserRole"))
                    role = result["UserRole"];
            }
            Message = "Password changed successfully! Redirecting...";
            await JS.InvokeVoidAsync("localStorage.removeItem", "authToken");

            StateHasChanged();
            await Task.Delay(1500);
            Message = string.Empty;

            await Task.Delay(300);
            switch (role)
            {
                
                case "Manager":
                    nav.NavigateTo("/manager");
                    break;
                default:
                    nav.NavigateTo("/member");
                    break;
            }
        }
        else
        {
            Message = await response.Content.ReadAsStringAsync();
        }
    }
}
