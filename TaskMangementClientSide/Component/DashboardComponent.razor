@using Task.Application.DTOs

@* @inject HttpClient Http *@
@inject NavigationManager nav;
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS


<style>
    .dropdown-item.text-danger:hover {
        background-color: #f8d7da;
        color: #b02a37 !important;
    }

    .detail-btn {
        padding: 8px 15px;
        background: #95a5a6;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        /* transition: background 0.3s ease; */
    }

        .detail-btn:hover {
            background-color: #a9a9a9; 
            color: white;
            /* transform: scale(1.05); */
            cursor: pointer;
        }

    .view-btn:hover {
        background-color: #A9A9A9 !important;
        color: white !important;
        
      
    }

    .edit-btn:hover {
        background-color: #1a252f !important;
        color: #ecf0f1 !important;
       
    }

    .text-btn {
        background: none;
        border: none;
        color: #2c3e50; /* dark text */
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        padding: 0;
        /* transition: 0.2s ease; */
    }

        .text-btn:hover {
            color: #1a242f; /* slightly darker on hover */
            text-decoration: underline;
        }

    .visibility-public, .visibility-private {
        font-size: 12px; /* Smaller text */
        padding: 3px 8px; /* Smaller padding */
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }

        .visibility-public i,
        .visibility-private i {
            font-size: 13px; /* Smaller icon */
        }

    .visibility-public {
        background-color: #e8fdf4 !important; /* mint green */
        color: #27ae60 !important; /* green text */
        font-weight: 500;
    }

    .visibility-private {
        background-color: #fdecec !important; /* light pink */
        color: #e74c3c !important; /* red text */
        font-weight: 400;
    }

 

        /* .delete-btn:hover {
            background: rgba(231, 76, 60, 0.8);
            transform: scale(1.1);
        } */
    .delete-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 2px solid #2c3e50; /* Red outline */
        display: flex;
        justify-content: center;
        align-items: center;
        background: transparent;
        color: #2c3e50;
        /* transition: 0.2s ease; */
        padding: 0;
    }

        .delete-btn:hover {
            background: #e74c3c;
            color: white;
            /* transform: scale(1.1); */
        }

    .modal-overlay {
        /* position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6); */
        z-index: 4000 !important;
    }


    .modal-content {
        /* position: relative;
        z-index: 5000 !important; */
        overflow:visible !important;
        position:relative;
        z-index:5000;
    }

   



    .multi-select {
        /* width: 100%;
        height:auto;
        min-height: 38px;
        padding: 6px 10px;
       
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        position: relative;
        z-index:6000; */
        position: relative;
        width:auto;
        min-height: 38px;
        padding: 6px 40px 6px 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
       background-color:white;
        z-index: 6000;
           display: flex;            
           align-items: center;  
           
           
        
    }

    

  

    .dropdown-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
     
    }


    .selected-area {
        flex-grow: 1;
        /* min-width: 0; */
       
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
        min-height: 24px;
    }

    /* .placeholder {
        color: #6c757d;
        font-size: 14px;
        opacity: 0.8;
        white-space: nowrap;
        pointer-events: none;
        display:inline-flex
    } */



    .dropdown-panel {
        /* position: absolute;
        top: 100%;
        left: 0;
        width: 100%; 
        background: white;
        border: 1px solid #ccc;
      
        border-radius: 6px;
        
        max-height: 220px !important; 
        overflow-y: auto !important; 
        z-index: 7000 !important; */
        
        /* position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 220px;
        overflow-y: auto;
        z-index: 7000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); */
        position: absolute;
        bottom: 100%; /* OPEN UPWARDS */
        top: auto;
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid #ccc;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
        max-height: 220px;
        overflow-y: auto;
        z-index: 7000;
        box-shadow: 0 -4px 8px rgba(0,0,0,0.1);
    }

    .multi-select.open {
        border-top: none;
        border-radius: 0 0 6px 6px;
    }


    .dropdown-item {
        padding: 8px 12px;
        cursor: pointer;
    }

        .dropdown-item:hover {
            background: #e9ecef;
        }

    .tag-item {
        background: #2c3e50;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
    }

    .remove-tag {
        background: none;
        border: none;
        color: white;
        margin-left: 5px;
        cursor: pointer;
    }

    /* .project-title {
        max-height: 48px; 
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.25rem;
    } */

    /* .project-title {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.25rem;
        margin-bottom: 2px;
    } */

    .project-title {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3rem;
        padding-bottom: 3px; /* prevents cutting when 1 line */
    }



    .filter-icon {
        display: flex;
        flex-direction: column; /* icon on top, label below */
        align-items: center; /* centers both horizontally */
        justify-content: center;
        cursor: pointer;
        width: 80px;
    }

    .icon-circle {
        width: 40px;
        height: 40px;
        font-size: 18px;
        background-color:white;
        border-radius: 50%; /* makes it a perfect circle */
        display: flex; /* centers icon */
        justify-content: center;
        align-items: center;
        box-shadow: 0 0 4px rgba(0,0,0,0.2);
    }

    .filter-panel {
        background: #ffffff;
        border: 1px solid #ccc;
        padding: 10px 12px;
        border-radius: 10px;
        display: inline-block;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }


    .filter-label {
        font-size: 14px;
        font-weight: 500;
        text-align: center;
        margin-top:6px;
        width:100%;
        white-space:nowrap;
    }

    .filter-icon:hover .icon-circle {
        background-color: #2c3e50;
        color: white;
        /* transform: scale(1.1); */
    }

    .filter-icon:hover .filter-label {
        color: #2c3e50;
    }

    .filter-container {
        display: flex;
        flex-direction: column; /* stack filter box BELOW icons */
        align-items: flex-start; /* left-align panel under icons */
    }

    .filter-wrapper {
        position: relative;
    }

    .floating-filter-panel {
        position: absolute;
        top: 60px; /* show box BELOW icons */
        left: 50%; /* center it */
        transform: translateX(-50%);
        background: white;

        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px 28px;
        min-width: 220px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999; /* stays above everything */
        justify-content: center; /* CENTER HORIZONTALLY */
        align-items: center;
    }

        .floating-filter-panel input,
        .floating-filter-panel select {
            width: 100%;
        }

        .floating-filter-panel .d-flex {
            justify-content: center; /* Center date range */
        }


    .filter-icon.active .icon-circle {
        background-color: #2c3e50;
        color: white;
        /* transform: scale(1.1); */
    }

    .filter-icon.active .filter-label {
        color: #2c3e50;
    }

    .modal-fixed-footer {
        display: flex;
        flex-direction: column;
        height: 100%; /* Fill modal height */
    }

    .modal-footer-stick {
        margin-top: auto; /* Push to bottom */
    }

    .clear-filter-btn {
        position: absolute;
        top: 12px;
        right: 6px;
        background: none;
        border: none;
       
        font-size: 22px; /* Increased from 16px → 22px */
        font-weight: 700;
        color: #888;
        cursor: pointer;
        padding: 0;
    }

        .clear-filter-btn:hover {
            color: #000;
            transform: scale(1.1);
        }

    .add-btn {
        height: 30px;
        width: 40px; 
        border: none;
        border-radius: 4px; 
        background-color: #2c3e50;
        color: white;
        /* font-size: 22px;
        font-weight: bold; */
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
          /* line-height: 0;      */
    padding: 0;  
        
    }

    .plus {
        font-size: 24px; /* increase + size */
        font-weight: bold;
        line-height: 1; /* FIX vertical alignment */
        display: flex; /* ensures perfect center */
        align-items: center;
        justify-content: center;
    }

        /* Hover effect */
        .add-btn:hover {
            background-color: #22303A;
           
           
        }

    .btn-create {
        background-color: #2c3e50;
        color: white;
    }

        .btn-create:hover{
        background-color: #22303A ;
        color:white;
    }

    .description-box {
        white-space: normal;
        word-break: break-word;
        min-height: calc(1.25rem * 3); /* 2 lines = 2 × line-height */
        line-height: 1.25rem; /* default for small text */
    }
       .desc-toggle-btn {
        font-size: 12px;
        border: none;
        background: #d5dfe6;
        color: black;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .desc-toggle-btn:hover{
        color:blue;
    }

</style>


<div class="container mt-4" >
        <div class="row g-4">

        <div class="col-md-3 col-sm-6" >
            <div class="card border-0 shadow-sm text-center py-4 " style="background-color:#ecf0f1">
                    <div class="text-primary fs-3 mb-2" >
                        <i class="bi bi-diagram-3"></i>
                    </div>
                    <h4 class="fw-bold text-dark mb-0">@stats.ActiveProjects</h4>
                    <p class="text-muted mb-0">Active Projects</p>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm text-center py-4" style="background-color:#ecf0f1">
                    <div class="text-primary fs-3 mb-2">
                        <i class="bi bi-people"></i>
                    </div>
                    <h4 class="fw-bold text-dark mb-0">@stats.TotalMembers</h4>
                    <p class="text-muted mb-0">Team Members</p>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm text-center py-4" style="background-color:#ecf0f1">
                    <div class="text-primary fs-3 mb-2">
                        <i class="bi bi-list-check"></i>
                    </div>
                    <h4 class="fw-bold text-dark mb-0">@stats.ActiveTasks</h4>
                    <p class="text-muted mb-0">Active Tasks</p>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm text-center py-4" style="background-color:#ecf0f1">
                    <div class="text-primary fs-3 mb-2">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <h4 class="fw-bold text-dark mb-0">@stats.CompletedTasks</h4>
                    <p class="text-muted mb-0">Completed Tasks</p>
                </div>
            </div>

        </div>
    </div>

<div class="container mt-4 d-flex justify-content-end">

    <button class="btn btn-secondary fw-semibold  px-3" @onclick="() => showCreateForm = true">
        <i class="bi bi-plus-lg me-1"></i> Create New Project
    </button>
</div>


  
    
        @if(showCreateForm)
        {
            <div class="modal-overlay">
                <div class="modal-content shadow-lg rounded-4 p-4 " style="background-color:#ecf0f1">
                    <h5 class="fw-bold mb-3 text-center"  style="color:#2c3e50;"> Create New Project</h5>
            <EditForm  EditContext="@formContext" Onsubmit="HandleSubmit">
                        <DataAnnotationsValidator/>
                       
                 
                    <div class="mb-3">
                            <label class="form-label fw-semibold " style="color:#2c3e50;">Project Name<span class="text-danger">*</span></label>
                            <InputText type="text" class="form-control "  @bind-Value="newProject.Name" placeholder="Enter project name" />
                        <ValidationMessage For="@(()=>newProject.Name)"/>
                    </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold " style="color:#2c3e50;">Description</label>
                            <textarea  class="form-control"  @bind="newProject.Description" placeholder="Enter description"></textarea>
                            <ValidationMessage For="@(() => newProject.Description)" />
                        </div>
              
                    <div class="mb-3 w-50 ">
                            <label class="form-label fw-semibold " style="color:#2c3e50;">Visibility<span class="text-danger">*</span></label>
                            <InputSelect class="form-select "  @bind-Value="newProject.Visibility">
                            <option value="Public">Public</option>
                            <option value="Private">Private</option>
                        </InputSelect>
                        <ValidationMessage For="@(()=>newProject.Visibility)"/>
                    
             </div>
                  

                <div class="mb-3 w-75">
                    <label class="form-label fw-semibold " style="color:#2c3e50;">
                        Assign Manager <span class="text-danger">*</span>
                    </label>

                    <div class="d-flex gap-1 align-items-center" >
                        <div class="multi-select @(showManagerDropdown ? "open" : "")  " style="flex-grow: 1;" @onclick="ToggleDropdown">

                        <div class="selected-area">
                            <span>@(newProject.ManagerIds.Count == 0 ? "Select managers..." : "Selected managers:")</span>
                        </div>
                        

                        <div class="dropdown-icon">
                            <i class="bi bi-chevron-down"></i>
                        </div>

                        @if (showManagerDropdown)
                        {
                            <div class="dropdown-panel shadow">
                                @foreach (var manager in managers)
                                {

                                    <div class="dropdown-item" @onclick:stopPropagation="true"  @onclick="() => SelectManager(manager.Id)">
                                        @manager.Name
                                    </div>
                                }
                            </div>
                        }
                        </div>
                        <button type="button" class="add-btn" @onclick="ShowAddForm"><Span class="plus mb-1">+</Span></button>
                    </div>

                 

                    @if (newProject.ManagerIds.Count > 0)
                    {
                        <div class="mt-2 d-flex flex-wrap gap-2">
                            @foreach (var id in newProject.ManagerIds)
                            {
                                var mgr = managers.FirstOrDefault(m => m.Id == id);
                                if (mgr != null)
                                {
                                    <span class="tag-item">
                                        @mgr.Name
                                        <button type="button" class="remove-tag"
                                                @onclick:stopPropagation="true"
                                                @onclick="() => RemoveManager(id)">
                                            ×
                                        </button>
                                    </span>
                                }
                            }
                        </div>
                    }

                    <ValidationMessage For="@(() => newProject.ManagerIds)" />
                </div>
                
              


                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" @onclick="() => showCreateForm = false">Cancel</button>
                            <button type="submit" class="btn btn-create" >Create</button>
                        </div>

                    </EditForm>
                </div>
            </div>
        }
        
        @if (showConfirmation) 
        {
            <div class="modal-overlay d-flex justify-content-center align-items-center">
        <div class="modal-content shadow-lg rounded-4 p-4 bg-white modal-fixed-footer" style="width: 600px; height:450px">
                   
                    <div class="border rounded-4 p-3 mb-4  mt-4 bg-light">
                        <h5 class="fw-bolder mb-3 text-center">Project Details</h5>

                        <p class="mb-2"><strong>Project Name:</strong> @newProject.Name></p>
                <p class="mb-2"><strong>Description:</strong> @newProject.Description</p>
                        <p class="mb-2"><strong>Visibility:</strong> @newProject.Visibility</p>
                        <p class="mb-2"><strong>Created On:</strong> @DateTime.Now.ToString("MMMM dd, yyyy")</p>
                        <p class="mb-0"><strong>Mangers:</strong> @newProject.ManagerNames
                        
                        
                        </p>
                    </div>

            <div class="text-center modal-footer-stick">Do you want to create this project?</div>

            <div class="d-flex justify-content-between modal-footer-stick">
                        <button class="btn btn-secondary w-50 me-2" @onclick="CancelConfirmation">Cancel</button>
                        <button class="btn btn-success w-50" @onclick="ConfirmProjectAsync">Create Project</button>
                    </div>

                 
                </div>
            </div>
        }

     

       <div class="container mt-5  ">
    <div class=" p-4 rounded-4" style="background-color:#ecf0f1">
       
        <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">

            <h4 class="fw-bold mb-0 text-dark">RecentProjects</h4>

            <div class="position-relative ms-auto" style="max-width:250px;">
                <input class="form-control pe-5"
                       placeholder="Search projects..."
                       @bind="search"
                       @bind:event="oninput"
                       @bind:after="ApplyFilters" />
                <span class="position-absolute top-50 end-0 translate-middle-y me-3 text-muted">
                    <i class="bi bi-search"></i>
                </span>
            </div>
            <div class="filter-wrapper position-relative">
                <div class="d-flex align-items-center justify-content-between w-100 gap-3">
            <div class="d-flex align-items-center gap-1">
                @* <h4 class="fw-bolder ">Filters</h4> *@

                    <div class="filter-icon @(activeFilter == "date" ? "active" : "")" @onclick='() => ToggleFilterPanel("date")'>
                    <div class="icon-circle"><i class="fas fa-calendar-alt"></i></div>
                    <span class="filter-label">Date</span>
                </div>

                    <div class="filter-icon @(activeFilter == "manager" ? "active" : "")" @onclick='() => ToggleFilterPanel("manager")'>
                    <div class="icon-circle"><i class="fas fa-user-tie"></i></div>
                    <span class="filter-label">Manager</span>
                </div>

                    <div class="filter-icon @(activeFilter == "range" ? "active" : "")" @onclick='() => ToggleFilterPanel("range")'>
                            <div class="icon-circle"><i class="fas fa-calendar-week"></i></div>
                    <span class="filter-label">Date Range</span>
                </div>
            </div>
                   
                    </div>
            @if (activeFilter == "date")
            {
                <div class="floating-filter-panel mt-2">
                        <button class="clear-filter-btn"
                                @onclick="() => { filterCreatedDate = null; ApplyFilters(); }">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                    <input type="date" class="form-control w-auto"
                           @bind="filterCreatedDate"
                           @bind:after="ApplyFilters" />
                </div>
            }

            @if (activeFilter == "manager")
            {
                <div class="floating-filter-panel mt-2">
                     <button class="clear-filter-btn"
                @onclick='() => { filterManagerId = ""; ApplyFilters(); }'>
                            <i class="bi bi-arrow-counterclockwise"></i>
        </button>
                    <select class="form-select w-auto"
                            @bind="filterManagerId"
                            @bind:after="ApplyFilters">
                        <option value="">All Managers</option>
                        @foreach (var m in managers)
                        {
                            <option value="@m.Id">@m.Name</option>
                        }
                    </select>
                </div>
            }

            @if (activeFilter == "range")
            {
                <div class="floating-filter-panel mt-2 d-flex gap-2">
                        <button class="clear-filter-btn"
                                @onclick="() =>
                                {
                                    filterStartDate = null;
                                    filterEndDate = null;
                                    ApplyFilters();
                                }">
                              <i class="bi bi-arrow-counterclockwise"></i>
                          </button>
                    <input type="date"
                           class="form-control w-auto"
                           @bind="filterStartDate"
                           @bind:after="ApplyFilters" />
                    <input type="date"
                           class="form-control w-auto"
                           @bind="filterEndDate"
                           @bind:after="ApplyFilters" />
                </div>
            }
               
            </div>
          


        </div>

            <div class="d-flex flex-wrap gap-2 mt-4 mb-4">
                <button class="btn @(selectedFilter == "All" ? "btn-secondary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                        @onclick='() => FilterProjects("All")'>
                    All Projects
                </button>

            <button class="btn @(selectedFilter == "Active" ? "btn-secondary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                        @onclick='() => FilterProjects("Active")'>
                    Active
                </button>

            <button class="btn @(selectedFilter == "Completed" ? "btn-secondary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                        @onclick='() => FilterProjects("Completed")'>
                    Completed
                </button>

            <button class="btn @(selectedFilter == "Archived" ? "btn-secondary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                        @onclick='() => FilterProjects("Archived")'>
                    Archived
                </button>
            </div>
           
       
        <div class="container-fluid px-3">
            <div class="row g-4">

                @if (isLoading)
                {
                    <div class="col-12 text-center my-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-secondary mt-3">Loading projects...</p>
                    </div>
                }
                else if (recentProjects == null || !recentProjects.Any())
                {
                    <div class="col-12 text-center my-5">
                        <h5 class="text-muted">No projects found for this filter.</h5>
                        <p class="text-secondary">Try selecting a different category or create a new project.</p>
                    </div>
                }
                else
                {
                    @foreach (var project in recentProjects)
                    {
                        <div class="col-12 col-sm-6 col-md-4 col-lg-4">
                            <div class="card border-0 shadow-sm rounded-4 h-100  project-card">
                                <div class="card-body d-flex flex-column justify-content-between ">
                                    <div>
                                        <div class="d-flex  justify-content-between align-items-center mb-2 gap-2" style="min-width:0;">

                                            <h5 class="fw-semibold text-dark mb-0 project-title" > @project.Name</h5>
                                            
                                                <button class="btn btn-sm delete-btn " @onclick="() => ConfirmDelete(project.Id)">
                                                    <i class="fas fa-trash-alt"></i>
                                            </button>
                                            </div>
                                        <p class="@GetVisibilityBadgeClass(project.Visibility) d-inline-flex align-items-center gap-1 px-3 py-1 rounded-pill">
                                            <i class="@GetVisibilityIcon(project.Visibility)"></i>
                                            @project.Visibility
                                        </p>


                                        </div>


                                        @* <div class="small mb-3">
                                        <p class="fw-normal text-dark mb-0 description-box ">@project.Description</p>
                                        </div> *@
                                    <div class="small mb-3">
                                        <p class="fw-normal text-dark mb-0"
                                           style="
                    white-space: normal;
                    word-break: break-word;
                    display: -webkit-box;
                    overflow: hidden;
                    -webkit-box-orient: vertical;
                    @(showFullDescription ? "" : "-webkit-line-clamp: 1;")
               ">
                                            @project.Description
                                        </p>

                                        @if (!string.IsNullOrWhiteSpace(project.Description) && project.Description.Length > 60)
                                        {
                                            <button class=" p-0 mt-1 desc-toggle-btn"
                                                    @onclick="ToggleDescription">
                                                @(showFullDescription ? "Hide ↑" : "Preview ↓")
                                            </button>
                                        }
                                    </div>

                                        <div class=" small mb-3 d-flex ">

                                            
                                           <span class="fw-bold"> CreatedOn:</span> @(project.CreatedDate?.ToString("MMM dd, yyyy") ?? "No due date")
                                            <span class="ms-3"><i class="bi bi-people-fill me-1 text-dark"></i>@project.MemberCount members</span>
                                        </div>


                                        <div class="progress mb-2" style="height: 8px;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                 style="width:@project.Progress%"
                                                 aria-valuenow="@project.Progress" aria-valuemin="0" aria-valuemax="100">
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <small>
                                                <span class="text-dark fw-semibold">Manager(s):</span>
                                            <span class="text-dark" style="white-space:normal; word-break:break-word;">@project.ManagerNames</span>
                                            </small>
                                            <small class="fw-semibold">@project.Progress%</small>
                                        </div>


                                        <div class="d-flex align-items-center flex-wrap">
                                            <div class="team-avatars d-flex mb-1">
                                                @if(project.MemberIntials!=null&&project.MemberIntials.Any())
                                                {
                                                    @foreach(var intials in project.MemberIntials.Take(3))
                                                    {
                                                        <div class="avatar-circle bg-secondary text-white">@intials</div>
                                                    }
                                                    @if(project.MemberCount>3)
                                                    {
                                                        <div class="avatar-circle bg-secondary text-white">+@(project.MemberCount-3)</div>
                                                    
                                                    }
                                                    }
                                                    else
                                                    {
                                                        <small class="text-muted">No memebers</small>
                                                    }

                                                
                                              
                                        </div>
                                            <small class="ms-2 text-black fw-medium">Team</small>
                                    </div>

                                    <div class="d-flex justify-content-between mt-3 flex-wrap" style="gap:10px;">
                                            <button class="btn btn-outline-secondary flex-grow-1 me-2 mb-2 mb-sm-0 view-btn" style=" background-color:#ecf0f1" @onclick="() => ViewProject(project.Id)">View </button>
                                            <button class="btn  flex-grow-1 edit-btn" style="background-color:#2c3e50; color:white;" @onclick="() => OpenEditPopup(project)">Edit</button>
                                            
                                           
                                    </div>
                                </div>
                            </div>
                        </div>
                       
                    }
                }
            </div>
        </div>
       
        <div class="d-flex justify-content-between align-items-center mt-4">
            <small class="text-muted">
                Showing @(((currentPage - 1) * pageSize) + 1)
                -
                @(Math.Min(currentPage * pageSize, totalProjects))
                of @totalProjects projects
            </small>
            <div class="d-flex align-items-center gap-3">
            <div class="d-flex  align-items-center gap-2 ">
                    <label class="text-muted small">Entries per page:</label>

                    <select class="form-select form-select-sm"
                            style="width: 80px;"
                            @bind="pageSize"
                            @bind:after="OnPageSizeChanged">
                        <option value="6">6</option>
                        <option value="12">12</option>
                        <option value="18">18</option>
                        <option value="24">24</option>
                    </select>
                </div>

         
            <nav>
                <ul class="pagination pagination-sm mb-0 shadow-sm">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="PreviousPage">Previous</button>
                    </li>

                    <li class="page-item active">
                        <span class="page-link">@currentPage</span>
                    </li>

                    <li class="page-item @(currentPage == GetTotalPages() ? "disabled" : "")">
                        <button class="page-link" @onclick="NextPage">Next</button>
                    </li>
                </ul>
            </nav>
        </div>
        </div>
        </div>
        </div>
       
@if (showEditForm)
{
    <div class="modal-overlay d-flex justify-content-center align-items-center">
        <div class="modal-content shadow-lg rounded-4 p-4 " style="width: 600px; background-color:#ecf0f1;">

            <h5 class="fw-bold mb-3 text-center" style="color:#2c3e50;">Edit Project</h5>

            <EditForm Model="@editProject" OnValidSubmit="UpdateProjectAsync">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">
                        Project Name <span class="text-danger">*</span>
                    </label>
                    <InputText class="form-control" 
                               @bind-Value="editProject.Name" />
                    <ValidationMessage For="@(() => editProject.Name)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold " style="color:#2c3e50;">Description</label>
                    <textarea class="form-control" @bind="editProject.Description" placeholder="Enter description"></textarea>
                    <ValidationMessage For="@(() => editProject.Description)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">Visibility</label>
                    <InputSelect class="form-select w-50" 
                                 @bind-Value="editProject.Visibility">
                        <option value="Public">Public</option>
                        <option value="Private">Private</option>
                    </InputSelect>
             </div>
                <div class="mb-3 w-75 ">
                    <label class="form-label fw-semibold " style="color:#2c3e50;">
                        Assign Manager <span class="text-danger">*</span>
                    </label>
                    <div class="d-flex gap-1 align-items-center">
                    <div class="multi-select @(showManagerDropdown ? "open" : "") " @onclick="ToggleDropdown">

                        <div class="selected-area">
                            <span>@(editProject.ManagerIds.Count == 0 ? "Select managers..." : "Selected managers:")</span>
                        </div>


                        <div class="dropdown-icon">
                            <i class="bi bi-chevron-down"></i>
                        </div>

                        @if (showManagerDropdown)
                        {
                            <div class="dropdown-panel shadow">
                                @foreach (var manager in managers)
                                {

                                    <div class="dropdown-item" @onclick:stopPropagation="true" @onclick="() => SelectManagerEdit(manager.Id)">
                                        @manager.Name
                                    </div>
                                }
                            </div>
                        }
                    </div>
                      <button type="button" class="add-btn" @onclick="ShowAddForm"><Span class="plus mb-1">+</Span></button>
                      </div>
                    @if (editProject.ManagerIds.Count > 0)
                    {
                        <div class="mt-2 d-flex flex-wrap gap-2">
                            @foreach (var id in editProject.ManagerIds)
                            {
                                var mgr = managers.FirstOrDefault(m => m.Id == id);
                                if (mgr != null)
                                {
                                    <span class="tag-item">
                                        @mgr.Name
                                        <button type="button" class="remove-tag"
                                                @onclick:stopPropagation="true"
                                                @onclick="() => RemoveManagerEdit(id)">
                                            ×
                                        </button>
                                    </span>
                                }
                            }
                        </div>
                    }

                    <ValidationMessage For="@(() => editProject.ManagerIds)" />
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-secondary" @onclick="() => showEditForm = false">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" style="background-color:#2c3e50;">
                        Update
                    </button>
                </div>

            </EditForm>
        </div>
    </div>
}
@if (showForm)
{
    <div class="modal-overlay">
        <div class="modal-content shadow-lg rounded-4 p-4 bg-white">
            <!-- Header -->
            <h5 class="fw-bold mb-3 text-center" style="color:#2c3e50;">
                <i class="bi @(currentUser.Id == 0 ? "bi-person-plus" : "bi-pencil-square") me-2"></i>
                @(currentUser.Id == 0 ? "Add Manager" : "Edit Manager")
            </h5>

            <!-- Form -->
            <EditForm Model="@currentUser" OnValidSubmit="SaveUser">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">Full Name<span class="text-danger">*</span></label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-0" style="background-color:#ecf0f1;">
                            <i class="bi bi-person-fill"></i>
                        </span>
                        <InputText class="form-control border-0 shadow-sm" style="background-color:#ecf0f1;"
                                   @bind-Value="currentUser.Name" placeholder="Enter  name" />
                    </div>
                    <ValidationMessage For="@(() => currentUser.Name)" class="text-danger small" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">Email Address<span class="text-danger">*</span></label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-0" style="background-color:#ecf0f1;">
                            <i class="bi bi-envelope-fill"></i>
                        </span>
                        <InputText type="email" class="form-control border-0 shadow-sm" style="background-color:#ecf0f1;"
                                   @bind-Value="currentUser.Email" placeholder="Enter email" />
                    </div>
                    <ValidationMessage For="@(() => currentUser.Email)" class="text-danger small" />
                </div>
                @if (!string.IsNullOrWhiteSpace(serverError))
                {
                    <div class="text-danger small mt-1">@serverError</div>
                }


                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background-color:#2c3e50;">
                         Save
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}


        @if (deletePopupVisible)
{
    <div class="modal-overlay d-flex justify-content-center align-items-center">
        <div class="modal-content shadow-lg rounded-4 p-4 bg-white" style="width:400px;">
            <h5 class="fw-bold text-center mb-3 text-danger">Delete Project</h5>

            <p class="text-center mb-4">Are you sure you want to delete this project?</p>

            <div class="d-flex justify-content-between">
                <button class="btn btn-secondary w-50 me-2" @onclick="CancelDelete">Cancel</button>
                <button class="btn btn-danger w-50" @onclick="DeleteProject">Delete</button>
            </div>
        </div>
    </div>
}






  

@code {

    private HttpClient Http => HttpClientFactory.CreateClient("AuthClient");

    private DashboardSummaryDto stats = new();
    private string selectedFilter = "All";

    private string searchText = string.Empty;
    private List<ProjectDto> recentProjects = new();
    private bool isLoading = true;
    private bool showCreateForm = false;
    private bool showConfirmation = false;
    private ProjectDto newProject = new();


    private AppUserDto? currentUser=new();
    private List<ManagerDto> managers = new();
    private bool isManagersLoading = true;
    private int currentPage=1;
    private int pageSize = 6;
    private bool showEditForm = false;
    private ProjectDto editProject = new();
    private bool deletePopupVisible = false;
    private int projectIdToDelete = 0;
    private bool showManagerDropdown = false;
    private EditContext? createProjectContext;
    private int totalProjects = 0;
    private string search = "";
    private string? filterManagerId = "";
    private DateTime? filterCreatedDate;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private string activeFilter = "";
    private EditContext formContext;
    private bool submitted = false;
    private bool showForm = false;
    private string serverError = "";
    private bool showFullDescription = false;









    protected override async Task OnInitializedAsync()
    {

        newProject = new ProjectDto();
        formContext = new EditContext(newProject);
        // _ = LoadDataAsync();
        var projectTask= FilterProjects("Active");
        var statsTask= LoadDashboardStats();
        var managerTask = LoadManagers();
        await Task.WhenAll(projectTask, statsTask,managerTask);
        createProjectContext = new EditContext(newProject);


    }
    // private async Task LoadDataAsync()
    // {
    //     await LoadManagers();
    //     await LoadDashboardStats();
    //     await FilterProjects("Active");
    // }
    private void ViewManagerProjects(int managerId, string managerName)
    {
        nav.NavigateTo($"/manager/{managerId}/{Uri.EscapeDataString(managerName)}");
    }

    private async Task LoadManagers()
    {
        try
        {
            isManagersLoading = true;
            var client=HttpClientFactory.CreateClient("AuthClient");


            managers = await client.GetFromJsonAsync<List<ManagerDto>>("api/Manager/All") ?? new List<ManagerDto>();
        }        
        catch(Exception ex)

        {
            Console.WriteLine($"Error loading managers: {ex.Message}");
        }
        finally
        {
            isManagersLoading = false;
        }
    }
    // private async Task OnManagerClick(int managerId)
    // {
    //     isLoading = true;
    //     StateHasChanged();

    //     try
    //     {
    //         var client = HttpClientFactory.CreateClient("AuthClient");
    //         recentProjects = await client.GetFromJsonAsync<List<ProjectDto>>($"api/Member/{managerId}") ?? new();
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine($"Error loading projects for manager: {ex.Message}");
    //     }
    //     finally
    //     {
    //         isLoading = false;
    //         StateHasChanged();
    //     }
    // }
    private void ShowAddForm()
    {
        currentUser = new AppUserDto
        {
            Role = "Manager"
        };
        showForm = true;
    }
    private async Task SaveUser()
    {
        serverError = "";

        if (string.IsNullOrWhiteSpace(currentUser.Role))
            currentUser.Role = "Manager";
        if (currentUser.Id == 0)
        {
            var client = HttpClientFactory.CreateClient("AuthClient");
            var response = await client.PostAsJsonAsync("api/Member", currentUser);
            if (response.IsSuccessStatusCode)
            {
                showForm = false;
                
                await LoadManagers();
            }
            else
            {
                serverError = await response.Content.ReadAsStringAsync();

            }
        }
       
     

        // showForm = false;

    }
    private void CancelEdit()
    {
        showForm = false;
        currentUser = new();
    }
    void ToggleDescription()
    {
        showFullDescription = !showFullDescription;
    }
    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return string.Empty;

        return string.Join("", name.Split(' ', StringSplitOptions.RemoveEmptyEntries)
                                   .Select(n => n[0]))
                                   .ToUpper();
    }
    private async Task OnPageSizeChanged()
    {
        currentPage = 1;
        await FilterProjects(selectedFilter, 1);
    }


    private async Task ApplyFilters()
    {
        await FilterProjects(selectedFilter, 1);
    }

    private async Task ResetFilters()
    {
        search = "";
        filterManagerId = "";
        filterCreatedDate = null;
        filterStartDate = null;
        filterEndDate = null;

        await FilterProjects(selectedFilter, 1);
    }
    private void ToggleFilterPanel(string panel)
    {
        if (activeFilter == panel)
            activeFilter = ""; 
        else
            activeFilter = panel;
    }
    private async Task FilterProjects(string filter, int page=1)
    {
        selectedFilter = filter;
        isLoading = true;
      
        try
        {
            var client = HttpClientFactory.CreateClient("AuthClient");
            var url = $"api/Project?filter={filter}&page={page}&pageSize={pageSize}";

            if (!string.IsNullOrWhiteSpace(search))
                url += $"&search={Uri.EscapeDataString(search)}";

            if (!string.IsNullOrWhiteSpace(filterManagerId))
                url += $"&managerId={filterManagerId}";

            if (filterCreatedDate.HasValue)
                url += $"&createdDate={filterCreatedDate:yyyy-MM-dd}";

            if (filterStartDate.HasValue)
                url += $"&startDate={filterStartDate:yyyy-MM-dd}";

            if (filterEndDate.HasValue)
                url += $"&endDate={filterEndDate:yyyy-MM-dd}";

            var response = await client.GetAsync(url);


            // var response = await client.GetAsync($"api/Project?filter={filter}&page={page}&pageSize={pageSize}");
            if (response.IsSuccessStatusCode)
            {
                var paged = await response.Content.ReadFromJsonAsync<PagedResult<ProjectDto>>() ?? new();
                // recentProjects.Reverse();

                if (paged != null)
                {
                    recentProjects = paged.Items;
                    totalProjects = paged.TotalCount;
                    currentPage = page;
                }
                else
                {
                    recentProjects = new();
                    totalProjects = 0;
                }
            }
            else
            {
                Console.WriteLine($"API Error: {response.StatusCode}");
                recentProjects = new();
                totalProjects = 0;
            }
        }



        catch (Exception ex)
        {
            Console.WriteLine($"Error loading filtered projects: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    // private void OnManagerChange(ChangeEventArgs e)
    // {
    //     var selected = e.Value as IEnumerable<string>;

    //     if (selected != null)
    //     {
    //         newProject.ManagerIds = selected
    //             .Select(int.Parse)
    //             .ToList();
    //     }
    // }

    private string GetVisibilityBadgeClass(string? visibility)
    {
        return visibility?.ToLower() switch
        {
            "public" => "visibility-public",
            "private" => "visibility-private",
            _ => "visibility-public"
        };
    }
    private string GetVisibilityIcon(string? visibility)
    {
        return visibility?.ToLower() switch
        {
            "public" => "bi bi-globe2",
            "private" => "bi bi-lock-fill",
            _ => "bi bi-globe2"
        };
    }
    private void ToggleDropdown()
    {
        showManagerDropdown = !showManagerDropdown;
    }

    private void SelectManager(int id)
    {
        if (!newProject.ManagerIds.Contains(id))
            newProject.ManagerIds.Add(id);

        showManagerDropdown = false;

        if (submitted)
        {
            formContext?.NotifyFieldChanged(
                new FieldIdentifier(newProject, nameof(newProject.ManagerIds))
            );
        }
    }

    private void RemoveManager(int id)
    {
        newProject.ManagerIds.Remove(id);

        if (submitted)
        {

            formContext?.NotifyFieldChanged(
                new FieldIdentifier(newProject, nameof(newProject.ManagerIds))
            );
        }
    }
    private void SelectManagerEdit(int id)
    {
        if (!editProject.ManagerIds.Contains(id))
            editProject.ManagerIds.Add(id);

        showManagerDropdown = false;

        StateHasChanged();
    }

    private void RemoveManagerEdit(int id)
    {
        editProject.ManagerIds.Remove(id);

        StateHasChanged();
    }


    private void OpenEditPopup(ProjectDto project)
    {
        editProject = new ProjectDto
        {
            Id = project.Id,
            Name = project.Name,
            Description = project.Description,
            Visibility = project.Visibility,
            CreatedDate = project.CreatedDate,
            ManagerIds = project.ManagerIds?.ToList() ?? new List<int>(),
        };

        showEditForm = true;
    }

    private void ShowConfirmation()
    {

        if (!string.IsNullOrWhiteSpace(newProject.Name))
        {
            showConfirmation = true;
        }
        else
        {
            Console.WriteLine("Please fill in all required fields before confirming.");
        }
    }

    private void CancelConfirmation()
    {

        showConfirmation = false;
        showCreateForm = true;
    }
    private async Task ConfirmProjectAsync()
    {
        try
        {

            var response = await Http.PostAsJsonAsync("api/Project", newProject);
            if (response.IsSuccessStatusCode)
            {
                var createdProject = await response.Content.ReadFromJsonAsync<ProjectDto>();
                Console.WriteLine("Created ID: " + createdProject?.Id);

                showConfirmation = false;
                showCreateForm = false;

                newProject = new ProjectDto();


                await FilterProjects(selectedFilter); // refresh project list
                // await LoadManagerAsync();


                // if (createdProject != null)
                // {

                //     nav.NavigateTo($"/project/{createdProject.Id}/dashboard");
                // }
                // else
                // {
                //     Console.WriteLine("Project created but no ID returned from API.");
                // }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Failed to create project: {error}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating project: {ex.Message}");
        }
    }

    // private void OnSearch()
    // {
    //     Console.WriteLine($"Search text: {searchText}");

    // }
    private void CreateProject()
    {
        nav.NavigateTo("/createproject");
    }


    // private void OpenProject(int projectId)
    // {

    // }

    private async Task LoadDashboardStats()
    {
        try
        {
            stats = await Http.GetFromJsonAsync<DashboardSummaryDto>("api/Dashboard/Summary") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard stats: {ex.Message}");
        }
    }

    private void HandleSubmit(EditContext context)
    {
        submitted = true;

        // Run Blazor built-in validation
        if (context.Validate())
        {
            newProject.ManagerNames = string.Join(", ",
           managers.Where(m => newProject.ManagerIds.Contains(m.Id))
                   .Select(m => m.Name));
            showCreateForm = false;
            showConfirmation = true;
        }
        else
        {
            showConfirmation = false;
            Console.WriteLine("Validation failed.");
        }
    }
    private void OnManagerSelected(ChangeEventArgs e)
    {
        var selected = e.Value as IEnumerable<string>;

        if (selected != null)
        {
            newProject.ManagerIds = selected
                .Select(int.Parse)
                .ToList();
        }
    }
    // private IEnumerable<ProjectDto> GetFilteredProjects()
    // {
    //     return recentProjects;
    // }


    private async Task UpdateProjectAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthClient");
            var response = await client.PutAsJsonAsync($"api/Project/{editProject.Id}", editProject);

            if (response.IsSuccessStatusCode)
            {
                var updatedProject = await response.Content.ReadFromJsonAsync<ProjectDto>();

                // Replace updated project inside the list
                var index = recentProjects.FindIndex(p => p.Id == editProject.Id);
                if (index >= 0)
                    recentProjects[index] = updatedProject;

                // Refresh dashboard stats
                editProject = updatedProject;

                // Refresh dashboard
               
                await LoadDashboardStats();

                showEditForm = false;
                StateHasChanged();
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine("Edit failed: " + error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error editing project: " + ex.Message);
        }
    }

    private void ViewProject(int projectId)
    {
        nav.NavigateTo($"/project/{projectId}/boards");
    }
    private int GetTotalPages()
    {
        
        return (int)Math.Ceiling((double)totalProjects / pageSize);
    }

    private async Task NextPage()
    {
        if (currentPage < GetTotalPages())
            await FilterProjects(selectedFilter, currentPage + 1);
    }
    

    private async Task PreviousPage()
    {
        if (currentPage > 1)
            await FilterProjects(selectedFilter, currentPage - 1);
    }

  
    private void ConfirmDelete(int projectId)
    {
        projectIdToDelete = projectId;
        deletePopupVisible = true;
    }

    private void CancelDelete()
    {
        deletePopupVisible = false;
        projectIdToDelete = 0;
    }

    private async Task DeleteProject()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("AuthClient");
            var response = await client.DeleteAsync($"api/Project/{projectIdToDelete}");

            if (response.IsSuccessStatusCode)
            {
                
                recentProjects.RemoveAll(p => p.Id == projectIdToDelete);

             
                var totalPages = GetTotalPages();
                if (currentPage > totalPages && currentPage > 1)
                    currentPage--;

                await LoadDashboardStats();
              

                deletePopupVisible = false;
                projectIdToDelete = 0;

                StateHasChanged();
            }
            else
            {
                Console.WriteLine("Failed to delete project.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting project: {ex.Message}");
        }
    }




  

}
