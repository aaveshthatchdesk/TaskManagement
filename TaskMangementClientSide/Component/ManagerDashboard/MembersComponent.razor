@using Task.Application.DTOs
@using TaskMangementClientSide.Services
@inject HttpClient Http
@inject IJSRuntime JS
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager nav;
@inject SpinnerService spinner;


<style>
    .btn-save:hover {
        background-color: #3e4a5a; /* Slightly lighter shade */
        color: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }

   .btn-add {
        background-color: #2c3e50 !important;
        color: white !important;
    }

        .btn-add:hover{
            background-color: #1a252f !important;
            color: white !important;
        }

    .btn-pencil {
        background-color: #2c3e50 !important;
        color: white !important;
    }

        .btn-pencil:hover {
            background-color: #1a252f !important;
            color: white !important;
        }


    .modal-content {
        width: 35%;
        max-width: 400px;
        min-width: 380px;
        height: auto;
        animation: fadeIn 0.3s ease-in-out;
    }

    .toast-container {
        position: fixed;
        bottom: 25px;
        right: 25px;
        z-index: 2000;
        animation: slideIn 0.4s ease;
    }

    .toast-message {
        background: #2c3e50;
        color: white;
        padding: 14px 22px;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,.18);
        animation: fadeOut 0.5s ease 2.5s forwards;
    }

    .pagination .page-link:focus {
        box-shadow: none !important;
        outline: none !important;
    }

    .pagination .page-link {
        outline: none;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(120%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    input:focus, select:focus {
        border-color: #2c3e50 !important;
        box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.25) !important;
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        z-index: 1050;
    }

</style>

<div class="card shadow-lg border" style="width: 100%;background-color:#F8F9FA;">
    <!-- Header -->
    @* <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom py-3"> *@
    <div class="card-header bg-white border-0 border-bottom shadow-sm rounded-top-4 py-3 px-4 d-flex flex-wrap justify-content-between align-items-center">
        <!-- Left: Title -->
        <div class="d-flex align-items-center gap-2">
            <i class="bi bi-people-fill fs-4 text-primary"></i>
            <h4 class="fw-bold m-0" style="color:#2c3e50;">Members</h4>
        </div>

        <!-- Right: Controls -->
        <div class="d-flex align-items-center gap-2 flex-wrap">

            <div class="position-relative" style="width: 420px;">
                <input type="text"
                       class="form-control ps-4 pe-5 py-2 shadow-sm"
                       placeholder="Search..."
                       @bind="searchTerm"
                       @bind:event="oninput"
                       @bind:after="() =>{currentPage=1; LoadappUsers();}"
                       style="
                   background-color: #f1f3f4;
                   border-radius: 12px;
                   border: 1px solid #ddd;
                   font-size: 15px;
                   height: 40px;
               " />
                <button class="btn position-absolute end-0 top-50 translate-middle-y me-2 border-0 bg-transparent text-secondary"
                        type="button">
                    <i class="bi bi-search fs-5"></i>
                </button>

                @* @bind="searchTerm" @bind:event="oninput" *@
            </div>


            <button class="btn btn-sm  btn-add px-3 shadow-sm d-flex align-items-center  " style="border-radius: 8px; height:40px" @onclick="ShowAddForm">
                <i class="bi bi-person-plus me-2"></i> Add Member
            </button>
            <button class="btn btn-secondary btn-sm px-3 shadow-sm d-flex align-items-center"
                    style="border-radius: 8px; height: 40px;"
                    @onclick="BackToDashboard">
                <i class="bi bi-arrow-left-circle me-2"></i> Back to Dashboard
            </button>
        </div>
    </div>
    @if (showForm)
    {
        <div class="modal-overlay">
            <div class="modal-content shadow-lg rounded-4 p-4 bg-white">
                <!-- Header -->
                <h5 class="fw-bold mb-3 text-center" style="color:#2c3e50;">
                    <i class="bi @(currentUser.Id == 0 ? "bi-person-plus" : "bi-pencil-square") me-2"></i>
                    @(currentUser.Id == 0 ? "Add Member" : "Edit Member")
                </h5>

                <!-- Form -->
                <EditForm Model="@currentUser" OnValidSubmit="SaveUser">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label fw-semibold" style="color:#2c3e50;">Full Name<span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-0" style="background-color:#ecf0f1;">
                                <i class="bi bi-person-fill"></i>
                            </span>
                            <InputText class="form-control border-0 shadow-sm" style="background-color:#ecf0f1;"
                                       @bind-Value="currentUser.Name" placeholder="Enter full name" />
                        </div>
                        <ValidationMessage For="@(() => currentUser.Name)" class="text-danger small" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold" style="color:#2c3e50;">Email Address<span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-0" style="background-color:#ecf0f1;">
                                <i class="bi bi-envelope-fill"></i>
                            </span>
                            <InputText type="email" class="form-control border-0 shadow-sm" style="background-color:#ecf0f1;"
                                       @bind-Value="currentUser.Email" placeholder="Enter email" />
                        </div>
                        <ValidationMessage For="@(() => currentUser.Email)" class="text-danger small" />
                    </div>

                    @* <div class="mb-3 w-75">
                        <label class="form-label fw-semibold" style="color:#2c3e50;">Role<span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-0" style="background-color:#ecf0f1;">
                                <i class="bi bi-person-badge"></i>
                            </span>
                            <InputSelect class="form-select border-0 shadow-sm" style="background-color:#ecf0f1;"
                                         @bind-Value="currentUser.Role">
                                <option value="">Select role</option>

                                <option value="Manager">Manager</option>
                                <option value="Member">Member</option>
                            </InputSelect>
                        </div>
                        <ValidationMessage For="@(() => currentUser.Role)" class="text-danger small" />
                    </div> *@

                    <!-- Buttons -->
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="background-color:#2c3e50;">
                            <i class="bi bi-check-circle me-2"></i> Save
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    }

    <!-- Table -->
    <div class="card-body">
        <table class="table table-striped table-bordered table-hover w-100 border mt-2 shadow-sm">
            <thead>
                <tr>
                    <th style="width:5%; background-color:#2c3e50; color:white;">#</th>
                    <th style="width:25%; background-color:#2c3e50; color:white;">Name</th>
                    <th style="width:30%; background-color:#2c3e50; color:white;">Email</th>
                    <th style="width:20%; background-color:#2c3e50; color:white;">Role</th>
                    <th style="width:20%; background-color:#2c3e50; color:white;" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <div class="mt-2 text-secondary">Loading members...</div>
                        </td>
                    </tr>
                }
                else if (appUsers == null || !appUsers.Any())
                {
                    <tr><td colspan="5" class="text-center text-muted py-3">No members found.</td></tr>
                }
                else
                {
                    @foreach (var (member, index) in appUsers.Select((m, i) => (m, (currentPage - 1) * pageSize + i + 1)))
                    {
                        <tr>
                            <td>@index</td>
                            <td>@member.Name</td>
                            <td>@member.Email</td>
                            <td>@member.Role</td>
                            <td class="text-center">
                                <button class="btn btn-pencil btn-sm me-2" @onclick="() => EditUser(member)">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" @onclick="() => ShowDeleteConfirm(member.Id)">
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
    @if (showDeleteConfirm)
    {
        <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center" style="z-index:1050;">
            <div class="bg-white shadow-lg rounded-4 p-4 text-center" style="width: 380px;">
                <i class="bi bi-exclamation-triangle-fill text-warning fs-1 mb-3"></i>
                <h5 class="fw-bold text-dark mb-2">Confirm Deletion</h5>
                <p class="text-muted small mb-4">Are you sure you want to delete this member? This action cannot be undone.</p>

                <div class="d-flex justify-content-center gap-3">
                    <button class="btn px-4 shadow-sm" style="background-color:#2c3e50; color:white;" @onclick="ConfirmDelete">
                        <i class="bi bi-check-circle me-1"></i> Yes, Delete
                    </button>
                    <button class="btn btn-outline-secondary px-4 shadow-sm" @onclick="CancelDelete">
                        <i class="bi bi-x-circle me-1"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    }
    <div class="d-flex justify-content-between align-items-center mt-2 px-3 mb-3">
        <small class="text-muted">
            Showing @(((currentPage - 1) * pageSize) + 1)
            -
            @(Math.Min(currentPage * pageSize, totalUsers))
            of @totalUsers Members
        </small>

       
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex  align-items-center gap-2 ">
                <label class="text-muted small">Entries per page:</label>

                <select class="form-select form-select-sm"
                        style="width: 80px;"
                        @bind="pageSize"
                        @bind:after="() =>{currentPage=1; LoadappUsers();}">
                    <option value="6">6</option>
                    <option value="12">12</option>
                    <option value="18">18</option>
                    <option value="24">24</option>
                </select>
            </div>
            <nav>
                <ul class="pagination pagination-sm mb-0 shadow-sm">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="PreviousPage">Previous</button>
                    </li>

                    @foreach (var i in GetVisiblePages())
                    {
                        <li class="page-item @(currentPage == i ? "active" : "")">
                            <button class="page-link" @onclick="() => GoToPage(i)">
                                @i
                            </button>
                        </li>
                    }

                    <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="NextPage">Next</button>
                    </li>
                </ul>
            </nav>
       

    </div>
    </div>

</div>
@if (showToast)
{
    <div class="toast-container">
        <div class="toast-message">
            @toastMessage
        </div>
    </div>
}


@code {

    private List<AppUserDto>? appUsers = new();
    private AppUserDto currentUser = new();
    private bool isLoading = false;

    private bool showForm = false;
    private string? message;
    private int currentPage = 1;
    private bool showDeleteConfirm = false;
    private int userIdToDelete;
    private int pageSize = 6;
    private bool showToast = false;
    private string toastMessage = "";
    private int totalUsers = 0;
    private string searchTerm = "";



    protected override Task OnInitializedAsync()
    {
        return LoadappUsers();
    }

    // private async Task LoadappUsers()
    // {
    //     isLoading = true;

    //     var url = $"api/Member/ForManager?pageNumber={currentPage}&pageSize={pageSize}";

    //     if (!string.IsNullOrWhiteSpace(searchTerm))
    //         url += $"&search={Uri.EscapeDataString(searchTerm)}";

    //     var response = await Http.GetFromJsonAsync<PagedResult<AppUserDto>>(url);

    //     appUsers = response?.Items ?? new();
    //     totalUsers = response?.TotalCount ?? 0;


    //     isLoading = false;
    // }
    private async Task LoadappUsers()
    {
        isLoading = true;
        StateHasChanged();
        try
        {
            var client = HttpClientFactory.CreateClient("AuthClient");
            var url = $"api/Member/ForManager?pageNumber={currentPage}&pageSize={pageSize}";

            if (!string.IsNullOrWhiteSpace(searchTerm))
                url += $"&search={Uri.EscapeDataString(searchTerm)}";

            var response = await client.GetAsync(url);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PagedResult<AppUserDto>>();

                appUsers = result?.Items ?? new List<AppUserDto>();
                totalUsers = result?.TotalCount ?? 0;
            }
            else
            {

                appUsers = new List<AppUserDto>();
                totalUsers = 0;
            }
        }

        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
            appUsers = new List<AppUserDto>();
            totalUsers = 0;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }




    }

    private void ShowAddForm()
    {
        currentUser = new AppUserDto()
        {
            Role="Member"
        };
        showForm = true;
    }
    private void EditUser(AppUserDto appUser)
    {
        currentUser = new AppUserDto
        {
            Id = appUser.Id,
            Name = appUser.Name,
            Email = appUser.Email,
            Role = "Member"

        };
        showForm = true;
    }
    private void CancelEdit()
    {
        showForm = false;
        currentUser = new();
    }
    private async Task SaveUser()
    {
        try
        {
            spinner.Show();
            await Task.Delay(400);
            currentUser.Role = "Member";
            if (currentUser.Id == 0)
            {
                var response = await Http.PostAsJsonAsync("api/Member", currentUser);
                if (response.IsSuccessStatusCode)
                    showForm = false;
                await ShowToast("User added successfully.");
            }
            else
            {
                var response = await Http.PutAsJsonAsync($"api/Member/{currentUser.Id}", currentUser);
                if (response.IsSuccessStatusCode)
                    showForm = false;
                await ShowToast("User updated successfully.");
            }


        }
        finally
        {
            spinner.Hide();
            isLoading = true;
            await LoadappUsers();
        }




    }

    private void ShowDeleteConfirm(int id)
    {
        userIdToDelete = id;

        showDeleteConfirm = true;
    }
    private async Task ConfirmDelete()
    {
        showDeleteConfirm = false;

        try
        {
            var response = await Http.DeleteAsync($"api/Member/{userIdToDelete}");
            if (response.IsSuccessStatusCode)
            {
                showForm = false;
                await ShowToast("Member deleted successfully.");
            }
            else
                message = "Failed to delete member.";
            isLoading = true;
            await LoadappUsers();

        }
        catch (Exception ex)
        {
            message = $"Error: {ex.Message}";
        }
    }
    private void CancelDelete()
    {
        showDeleteConfirm = false;
    }
    private async Task DeleteMember(int id)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this member?");
        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/Member/{id}");
            if (response.IsSuccessStatusCode)
                message = "Member deleted.";
            else
                message = "Failed to delete member.";
            await LoadappUsers();
        }
    }
    private void BackToDashboard()
    {
        nav.NavigateTo("/dashboard"); // change the route as per your dashboard page
    }
    private int TotalPages =>
   (int)Math.Ceiling((double)totalUsers / pageSize);

    private List<int> GetVisiblePages()
    {
        int max = 5;
        int start = Math.Max(1, currentPage - 2);
        int end = Math.Min(TotalPages, start + max - 1);
        return Enumerable.Range(start, end - start + 1).ToList();
    }
    private async Task NextPage()
    {
        if (currentPage < TotalPages)
            currentPage++;
        await LoadappUsers();
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
            currentPage--;
        await LoadappUsers();
    }

    private async Task GoToPage(int page)
    {
        currentPage=page;
        await LoadappUsers();
    }
    private async Task ShowToast(string msg)
    {
        toastMessage = msg;
        showToast = true;
        StateHasChanged();

        await Task.Delay(1000);
        showToast = false;
        StateHasChanged();
    }



}
