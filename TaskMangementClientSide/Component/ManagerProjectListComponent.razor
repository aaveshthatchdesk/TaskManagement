@using Task.Application.DTOs
@inject IHttpClientFactory HttpClientFactory
<style>
    .close-btn {
        transition: 0.2s ease;
    }

        .close-btn:hover {
            background-color: #2c3e50 !important; 
            color: white !important;
            transform: scale(1.05); 
            cursor: pointer;
        }

    .save-btn {
        background-color: #2c3e50 !important;
        color: white !important;
       
    }

      .save-btn:hover {
            background-color: #0d6efd !important;
            color: #ecf0f1 !important; 
            cursor: pointer;
        }

    .edit-overlay {
        position: fixed;
        top: 65px; /* same as panel */
        left: 0;
        width: 100%;
        height: calc(100vh - 60px);
        background: rgba(0,0,0,0.2);
        z-index: 998;
    }

    /* SLIDE PANEL */
    .edit-panel {
        position: fixed;
        top: 65px; /* ⬅ Below the header */
        right: -450px;
        width: 450px;
        height: calc(100vh - 60px); /* ⬅ Avoid overlapping bottom */
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.2);
        z-index: 999; /* ⬅ Below header z-index */
        padding: 25px;
        border-radius: 12px 0 0 12px;
        transition: right 0.35s ease-in-out;
        overflow-y: auto;
    
    }

        /* When open */
        .edit-panel.open {
            right: 0;
        }

    .view-btn:hover {
        background-color: #0d6efd !important;
        color: white !important;
        border-color: #0d6efd !important;
        transform: scale(1.02);
    }

    .edit-btn:hover {
        background-color: #1a252f !important; 
        color: #ecf0f1 !important;
        transform: scale(1.02);
    }

    .visibility-public, .visibility-private {
        font-size: 12px; /* Smaller text */
        padding: 3px 8px; /* Smaller padding */
        font-weight: 600;
        display: inline-flex;
        align-items: center;
    }

        .visibility-public i,
        .visibility-private i {
            font-size: 13px; /* Smaller icon */
        }

    .visibility-public {
        background-color: #e8fdf4 !important; /* mint green */
        color: #27ae60 !important; /* green text */
        font-weight: 500;
    }

    .visibility-private {
        background-color: #fdecec !important; /* light pink */
        color: #e74c3c !important; /* red text */
        font-weight: 400;
    }


</style>



<div class="container-fluid shadow px-3 p-4 rounded-4" style="background-color:#ecf0f1;">
   
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex justify-content-start gap-2">
            <button class="btn btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center"
                    style="width: 40px; height: 40px; padding: 0;"
                    @onclick="Back">
                <i class="bi bi-arrow-left"></i>
            </button>
       
        <h3 class="fw-bold text-dark"> Projects</h3>
        </div>
        <div class="position-relative" style="width: 260px;">
            <input class="form-control ps-3 pe-5 shadow-sm"
                   placeholder="Search projects..."
                   @bind="searchTerm"
                   @bind:event="oninput" />
            <span class="position-absolute top-50 end-0 translate-middle-y me-3 text-muted">
                <i class="bi bi-search"></i>
            </span>
        </div>
        </div>
    

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-secondary mt-3">Loading projects...</p>
        </div>
    }
    else if (projects == null || !projects.Any())
    {
        <div class="text-center text-muted my-5">
            <h5>No projects found for this manager.</h5>
        </div>
    }
    else
    {
        <div class="d-flex flex-wrap gap-2 mb-4">
            <button class="btn @(selectedFilter == "All" ? "btn-primary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                    @onclick='() => FilterProjects("All")'>
                All
            </button>

            <button class="btn @(selectedFilter == "Active" ? "btn-primary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                    @onclick='() => FilterProjects("Active")'>
                Active
            </button>

            <button class="btn @(selectedFilter == "Completed" ? "btn-primary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                    @onclick='() => FilterProjects("Completed")'>
                Completed
            </button>

            <button class="btn @(selectedFilter == "Archived" ? "btn-primary text-white" : "bg-light text-dark") fw-semibold px-3 py-1"
                    @onclick='() => FilterProjects("Archived")'>
                Archived
            </button>
        </div>

        <div class="row g-4">
            @foreach (var project in GetPaginatedProjects())
            {
                <div class="col-12 col-sm-6 col-md-4 col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100 project-card">
                        <div class="card-body d-flex flex-column justify-content-between">
                            <div>
                                <div class="d-flex justify-content-between align-items-start mb-2 gap-2">
                                    <span class="fw-semibold text-dark text-truncate pe-2" style="max-width:70%">@project.Name</span>
                                    <span class="@GetVisibilityBadgeClass(project.Visibility) d-inline-flex align-items-center gap-1 px-3 py-1 rounded-pill">
                                        <i class="@GetVisibilityIcon(project.Visibility)"></i>
                                        @project.Visibility
                                    </span>
                                </div>
                                <div class="small mb-3">
                                    <span class="fw-bold">Created On:</span>
                                    @(project.CreatedDate?.ToString("MMM dd, yyyy") ?? "N/A")
                                    <span class="ms-3"><i class="bi bi-people-fill me-1 text-dark"></i>@project.MemberCount members</span>
                                </div>
                            </div>

                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar bg-primary" role="progressbar"
                                     style="width:@project.Progress%"
                                     aria-valuenow="@project.Progress" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Progress</small>
                                <small class="fw-semibold">@project.Progress%</small>
                            </div>

                            <div class="d-flex justify-content-between mt-3 flex-wrap">
                                <button class="btn btn-outline-primary flex-grow-1 me-2 mb-2 mb-sm-0 view-btn" @onclick="()=>ShowDetails(project)">View Details</button>
                                <button class="btn  flex-grow-1 edit-btn" style="background-color:#2c3e50; color:white;" @onclick="()=>OpenEdit(project)">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    <div class="d-flex justify-content-between align-items-center mt-4">
        <small class="text-muted">
            Showing @(((currentPage - 1) * pageSize) + 1)
            -
            @(Math.Min(currentPage * pageSize, GetFilteredProjects().Count()))
            of @GetFilteredProjects().Count() projects
        </small>

        <nav>
            <ul class="pagination pagination-sm mb-0 shadow-sm">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="PreviousPage">Previous</button>
                </li>

                <li class="page-item active">
                    <span class="page-link">@currentPage</span>
                </li>

                <li class="page-item @(currentPage == GetTotalPages() ? "disabled" : "")">
                    <button class="page-link" @onclick="NextPage">Next</button>
                </li>
            </ul>
        </nav>
    </div>

   
</div>



@if (selectedProject != null)
{
    <div class="mt-5 p-4 bg-white shadow rounded-4">
        <div class="d-flex justify-content-between">
            <h4 class="fw-bold">@selectedProject.Name</h4>
            <button class="btn btn-sm btn-secondary close-btn" @onclick="() => selectedProject = null"> X Close</button>
        </div>

        <hr />

        <div class="row mt-3">

            <!-- LEFT -->
            <div class="col-md-6">
                <h6 class="fw-bold text-primary">
                    <i class="bi bi-info-circle-fill me-1"></i> Project Details
                </h6>
                <p>@(string.IsNullOrWhiteSpace(selectedProject?.Description) ? "No details" : selectedProject.Description)</p>
               

                <h6 class="fw-bold text-primary mt-4">
                    <i class="bi bi-list-check me-1"></i> Tasks
                </h6>

                <ul class="list-unstyled">
                    @foreach (var t in selectedProject.Tasks)
                    {
                        <li><i class="bi bi-check-circle-fill text-success me-1"></i> @t</li>
                    }
                </ul>
            </div>

            <!-- RIGHT -->
            <div class="col-md-6">
                <h6 class="fw-bold text-primary">
                    <i class="bi bi-gear-fill me-1"></i> Project Info
                </h6>

                <p><strong>Status:</strong> @selectedProject.Status</p>
                <p><strong>Priority:</strong> @selectedProject.Priority</p>
            

                <h6 class="fw-bold text-primary mt-4">
                    <i class="bi bi-people-fill me-1"></i> Team Members
                </h6>

                <div class="d-flex flex-wrap gap-2">
                    @foreach (var tm in selectedProject.TeamMembers)
                    {
                        <span class="badge bg-primary rounded-pill px-3 py-2">@tm</span>
                    }
                </div>

                <h6 class="fw-bold text-primary mt-4">
                    <i class="bi bi-person-badge-fill me-1"></i> Project Manager
                </h6>

                <p class="mb-1"><strong>@selectedProject.ManagerNames</strong></p>
                <p class="mb-1"><i class="bi bi-envelope-fill"></i> @selectedProject.ManagerEmail</p>
               
            </div>
        </div>
    </div>
}
@if (showEditPanel && editProject != null)
{
    <div class="edit-overlay" @onclick="CloseEdit"></div>

    <div class="edit-panel @(showEditPanel ? "open" : "")">

        <div class="d-flex justify-content-between mb-3">
            <h4 class="fw-bold">Edit Project</h4>
            <button class="btn btn-sm btn-secondary close-btn" @onclick="CloseEdit">Close</button>
        </div>

        <hr />

        <div>
            <div class="mb-3">
                <label class="fw-semibold">Project Name</label>
                <input class="form-control" @bind="editProject.Name" />
            </div>

            <div class="mb-3">
                <label class="fw-semibold">Description</label>
                <textarea class="form-control" rows="4" @bind="editProject.Description"></textarea>
            </div>

            <div class="mb-3">
                <label class="fw-semibold">Priority</label>
                <select class="form-select" @bind="editProject.Priority">
                    <option>Low</option>
                    <option>Medium</option>
                    <option>High</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="fw-semibold">Status</label>
                <input class="form-control" @bind="editProject.Status" />
            </div>

            <button class="btn  w-100 save-btn"@onclick="SaveProject">Save Changes</button>
        </div>
    </div>
}


    
@code {
    [Parameter] public int ManagerId { get; set; }
    [Parameter] public string ManagerName { get; set; } = string.Empty;
    [Parameter] public EventCallback OnBack { get; set; }

    private List<ProjectDto> projects = new();
    private bool isLoading = true;
    private string selectedFilter = "All";
    private bool showEditPanel = false;
    private ProjectDto? editProject;

    private ProjectDto? selectedProject;

    private string searchTerm = "";
    private int currentPage = 1;
    private int pageSize = 3;

    protected override async Task OnInitializedAsync()
    {
        await LoadManagerProjects();
    }

    private void ShowDetails(ProjectDto project)
    {
        selectedProject = project;
        StateHasChanged();
    }

    private void OpenEdit(ProjectDto project)
    {
        editProject = new ProjectDto
        {
            Id = project.Id,
            Name = project.Name,
            Description = project.Description,
            Priority = project.Priority,
            CreatedDate = project.CreatedDate,
            Visibility = project.Visibility,
            Progress = project.Progress,
            Status = project.Status,

            TeamMembers = new List<string>(project.TeamMembers),

        };
        showEditPanel = true;
    }
    private async Task SaveProject()
    {
        var client = HttpClientFactory.CreateClient("AuthClient");

        var response = await client.PutAsJsonAsync($"api/Project/{editProject.Id}", editProject);

        if (response.IsSuccessStatusCode)
        {

            await LoadManagerProjects();


            showEditPanel = false;
            editProject = null;
        }
        else
        {
            Console.WriteLine("Failed to update project: " + await response.Content.ReadAsStringAsync());
        }
    }

    private async Task LoadManagerProjects()
    {
        try
        {
            isLoading = true;
            var client = HttpClientFactory.CreateClient("AuthClient");
            projects = await client.GetFromJsonAsync<List<ProjectDto>>($"api/Manager/ProjectsGetByManager/{ManagerId}") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading manager projects: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task FilterProjects(string filter)
    {
        selectedFilter = filter;
        currentPage = 1;
        isLoading = true;
        try
        {
            var client = HttpClientFactory.CreateClient("AuthClient");
            projects = await client.GetFromJsonAsync<List<ProjectDto>>($"api/Project/GetByManager/{ManagerId}?filter={filter}") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error filtering projects: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    private string GetVisibilityBadgeClass(string? visibility)
    {
        return visibility?.ToLower() switch
        {
            "public" => "visibility-public",
            "private" => "visibility-private",
            _ => "visibility-public"
        };
    }
    private string GetVisibilityIcon(string? visibility)
    {
        return visibility?.ToLower() switch
        {
            "public" => "bi bi-globe2",
            "private" => "bi bi-lock-fill",
            _ => "bi bi-globe2"
        };
    }
    private IEnumerable<ProjectDto> GetFilteredProjects()
    {
        return projects
            .Where(p =>
                string.IsNullOrWhiteSpace(searchTerm)
                || p.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (p.Description?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
            )
            .Where(p =>
                selectedFilter == "All"
                || (p.Status != null && p.Status.Equals(selectedFilter, StringComparison.OrdinalIgnoreCase))
            )
            .ToList();
    }

    private IEnumerable<ProjectDto> GetPaginatedProjects()
    {
        var filtered = GetFilteredProjects();
        return filtered
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private int GetTotalPages()
    {
        var filtered = GetFilteredProjects();
        return (int)Math.Ceiling((double)filtered.Count() / pageSize);
    }


    private void NextPage()
    {
        if (currentPage < GetTotalPages())
            currentPage++;
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
            currentPage--;
    }


    private async Task Back()
    {
        await OnBack.InvokeAsync();
    }
    private void CloseEdit()
    {
        showEditPanel = false;
        editProject = null;
    }
}
