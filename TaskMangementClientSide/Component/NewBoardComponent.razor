@using Microsoft.AspNetCore.Components.Authorization
@using System.Threading.Tasks
@using Task.Application.DTOs
@using TaskMangementClientSide.Component.Sprint
@inject NavigationManager nav;
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider;

<style>
    
     .card {
       
        border-radius: 12px !important;
        overflow: hidden; 
        box-shadow: none !important;
    }
  
    .task-card {
        /* min-height: 240px; */
        max-height:400px;/* consistent height */
        display: flex;
        flex-direction: column;
        justify-content: start;
        gap:6px;
        overflow:visible;
    }
      .add-btn {
        height: 35px;
        width: 35px; 
        border: none;
        border-radius: 4px; 
        background-color: #2c3e50;
        color: white;
         font-size:20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        
    padding: 0;  
        
    }
     .kanban-column {
        position: relative;
        overflow: visible !important;
    }

   



    .kanban-tasks {
        max-height: 60vh; /* sets a cap but allows natural shrinking */
        overflow-y: auto;
        padding-right: 6px;
    }


    

    .modal-backdrop-custom {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        z-index: 1040;
    }

   
    .custom-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        width: 420px;
        border-radius: 12px;
        overflow:hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 1050;
        padding: 0;
    }

  
    .custom-modal-header {
        padding: 15px 20px;
        background: #ffffff;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top-left-radius: 12px; /
        border-top-right-radius: 12px;
    }
 
    .custom-modal-body {
        padding: 20px;
    }

   
    .custom-modal-footer {
        padding: 12px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid #eee;
    }


     .task-avatar-stack {
        display: flex;
        align-items: center;
    }

    .task-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #546476;
        color: white;
        font-size: 12px;

        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-left: -8px; /* 👈 overlap effect */
        border: 2px solid white; /* clean ring */
    }

        .task-avatar:first-child {
            margin-left: 0;
        }


        .desc-toggle-btn {
        font-size: 12px;
        border: none;
        background: #d5dfe6;
        color: black;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

        .desc-toggle-btn:hover {
            text-decoration: underline;
        }

    .description-expanded {
        white-space: pre-line;
    }
    .task-no-desc-gap {
    margin-top: 12px;   
    display: block;
}

.task-actions {
    margin-top: auto;   
    padding-top: 8px;   
}
dropdown-submenu {
        position: relative;
    }

        /* Show submenu on hover */
        .dropdown-submenu:hover > .dropdown-submenu-menu {
            display: block;
        }

  
    .dropdown-submenu-menu {
    position: fixed !important;
    z-index: 6000 !important;
    max-height: 300px;
    overflow-y: auto;
    /* background-color:#ecf0f1; */
}


    /* Fix clipping */
    .dropdown-menu {
        overflow: visible !important;
    }



    /* Align arrow + text */
    .dropdown-submenu > a.dropdown-toggle {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between;
        width: 100%;
    }

        /* Replace default arrow with custom right arrow */
        .dropdown-submenu > a.dropdown-toggle::after {
            content: "⯆" !important;

            font-size: 16px;
            margin-left: 8px;
            margin-right: 1px;
            border: none !important;
        }

    .priority-low-border {
        border-left: 5px solid #27ae60 !important;
    }

    .priority-medium-border {
        border-left: 5px solid #f1c40f !important;
    }

    .priority-high-border {
        border-left: 5px solid #e67e22 !important;
    }
      .kanban-tasks:empty {
        min-height: 10px;
    }

    .badge-tall {
        padding: 2px 8px !important;
        font-size: 0.9rem !important;
        line-height: 1.1rem !important;
    }

    .form-control:focus {
        box-shadow: none !important;
        border-color: #ccc !important;
    }

   
    
    
    .form-check-input:checked {
        background-color: #2c3e50 !important;
        border-color: #2c3e50 !important;
        
    }

    .delete-btn:hover i {
        color: red !important; 
    }
    .deletebtn{
        background-color:#2c3e50;
        color:white;
    }
    .deletebtn:hover{
            background-color: #22303A;
            color:white;
    }

    .savebtn {
        background-color: #2c3e50;
        color: white;
    }

        .savebtn:hover {
            background-color: #22303A;
            color: white;
        }

        .delete-circle-btn {
       

        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: transparent;
        color: #cc0000;
        font-size: 25px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 !important;
      
        margin-top: -25px;
        line-height: 30px;
        transition: background 0.2s ease, transform 0.2s ease;
    }

        .delete-circle-btn:hover {
           

            background: rgba(204, 0, 0, 0.15);
           
        }
        .deletemember-circle-btn
        {
            width: 24px;
            height: 24px;
            border-radius: 50%;

            color: #cc0000;
            background: transparent;
            font-size: 18px;
            font-weight: 700;
            line-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom:0;
        margin-top: -15px;
            transition: transform 0.2s ease;

        }

    .deletemember-circle-btn:hover {
       

        background: rgba(204, 0, 0, 0.15);
        
    }
    .filename-clamp {
        display: -webkit-box;
        -webkit-line-clamp: 2; 
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
    }
    .attachment-card {
        position: relative;
    }

    .delete-attachment-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        z-index: 10;
        border-radius: 50%;
        padding: 2px 6px;
        line-height: 1;
    }

        .delete-attachment-btn:hover {
            background: rgba(220, 53, 69, 0.15);
        }

    .attachment-link {
        display: flex;
        align-items: center;
    }

    .custom-modal {
        max-height: 90vh; /* FIXED HEIGHT */
        display: flex;
        flex-direction: column;
        overflow: hidden; /* prevent modal itself from growing */
    }

    .custom-modal-header {
        flex-shrink: 0; /* header never shrinks */
        border-bottom: 1px solid #e5e5e5;
    }
    .custom-modal-body {
        flex: 1; /* take remaining height */
        overflow-y: auto; /* SCROLL HERE */
        padding: 1rem;
    }

    .attachment-box {
        width: 240px; /* FIXED WIDTH */
        height: 80px; /* FIXED HEIGHT */
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .commenttext
    {
        max-height:250px;
        overflow-y: auto;
    }
    .cmt-btn
    {
        background-color:#2c3e50;
        color:white;
    }
    .cmt-btn:hover
    {
            background-color: #22303A;
            color:white;
        }

</style>













<div style="display: inline-block;">
    <div class="d-flex justify-content-start gap-2">
        <button class="btn btn-back d-flex align-items-center justify-content-center fw-bolder"
                style="width: 40px; height: 40px; padding: 0; font-size:20px;"
                @onclick="Back">
            <i class="bi bi-arrow-left bold-arrow"></i>
        </button>
        <h2 class="fw-bold text-dark mb-0" style="font-family: 'Poppins', sans-serif;">
        <i class="bi bi-kanban me-2"></i> @CurrentProject.Name
    </h2>
    </div>

    <div style="text-align: right; padding-left:110px; margin-top: 2px;">
        <small class="text-dark">
            Created on: @CurrentProject.CreatedDate?.ToString("dd MMM yyyy")
        </small>
    </div>
</div>


<div class="d-grid gap-4 mb-4 mt-4"
     style="grid-template-columns: 2fr 2fr; align-items:start;">

    <!-- Managers Card (Top-Left) -->
     <div class="card shadow-sm rounded-4"
         style="min-width: 530px;">

       
        <div class="d-flex justify-content-between align-items-center px-3 py-1 rounded-top"
             style="background: linear-gradient(135deg, #283048, #859398);
 color:white;">
            <h6 class="fw-bold m-0">Managers</h6>
            <div class="d-flex gap-3 ">
                <div class="d-flex align-items-center">
                    <span class="badge  badge-tall bg-light text-dark">@managers.Count</span>
                </div>
            <button class="btn  btn-light"
                        style=" width:25px; height:25px; border-radius:50%; padding:0;"
                    @onclick="ShowMangerModal">
                <i class="bi bi-plus-lg"></i>
            </button>
            </div>


        </div>
        

       <div class="card-body p-3">
            <div class="d-flex gap-3 overflow-x-auto py-2 mt-2">
        @foreach (var manager in managers)
        {
            <div class="d-flex align-items-center">
                  <div class="rounded-circle   me-3 d-flex align-items-center justify-content-center"
                             style="width:50px; height:50px; border:1px solid #283048 ;">

                            <span class="fw-bold fs-5">@GetInitials(manager.Name)</span>
                        </div>
                <div>
                            <div class="fw-semibold" style="padding-top:0.6rem; padding-bottom:0.3rem">@manager.Name</div>
                    @* <div class="text-muted small">@manager.Role</div> *@
                </div>
                        <button type="button"
                                class="btn btn-sm delete-circle-btn"
                                @onclick="() => OpenDeleteManagerConfirm(manager.Id)">
                            <span padding-bottom:2px;>-</span>
                        </button>
              
              
                
                    <div class="vr mx-3" style="height: 40px;"></div>
                
                        
            </div>
        }
    </div>
</div>
    </div>
    @if (showManagerModal)
    {
        


        <div class="modal-overlay d-flex justify-content-center align-items-center">
            <div class="modal-content shadow-lg rounded-4 p-4"
                 style="width: 500px; background-color:#ecf0f1;">

                <h5 class="fw-bold mb-3 text-center" style="color:#2c3e50;">
                    Select Managers
                </h5>

                <!-- Manager Select Form -->
                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">
                        Choose Managers
                    </label>

                    <select class="form-select" @bind="selectedManagerId" @key="selectedManagerId">
                        <option value="0" disabled selected hidden>Select managers</option>
                       

                        @foreach (var m in allManagers)
                        {
                            <option value="@m.Id">@m.Name</option>
                        }
                    </select>
                    @if (managerError != null)
                    {
                        <div class="text-danger mb-2">@managerError</div>
                    }
                </div>

                <button class="btn btn-primary mb-3"
                        style="background-color:#2c3e50;"
                        @onclick="AddManagerToSelection">
                    Add Manager
                </button>

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">
                        Selected Managers:
                    </label>

                    @if (selectedManagers.Count == 0)
                    {
                        <div class="text-muted">No managers selected</div>
                    }
                    else
                    {
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var m in selectedManagers)
                            {
                                <span class="tag-item">
                                    @m.Name
                                    <button type="button" class="remove-tag"
                                            @onclick="() => RemoveManager(m.Id)">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    }
                </div>

                <!-- Footer Buttons -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-secondary" @onclick="() => showManagerModal = false">
                        Cancel
                    </button>

                    <button class="btn savebtn"
                            
                            @onclick="SaveManagerSelection">
                        Save Selection
                    </button>
                </div>

            </div>
        </div>
    }
    @if (showDeleteManagerConfirm)
    {
        <div class="modal-backdrop-custom"></div>

        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="m-0 fw-bold">Confirm Delete</h5>
                <button class="btn-close" @onclick="CloseDeleteConfirm"></button>
            </div>

            <div class="custom-modal-body">
                <p class="text-dark">
                    Are you sure you want to remove this manager from the project?
                </p>
            </div>

            <div class="custom-modal-footer">
                <button class="btn btn-secondary" @onclick="CloseDeleteConfirm">
                    Cancel
                </button>

                <button class="btn deletebtn" @onclick="DeleteManagerConfirmed">
                    Remove
                </button>
            </div>
        </div>
    }

     <!-- Sprints Card (Below Manager, Left Column) -->
    <div class="card shadow-sm rounded-4"
         style="min-width: 520px; ">

        <div class="d-flex justify-content-between align-items-center px-3 py-1 rounded-top"
             style="background: linear-gradient(135deg, #283048, #859398);
 color:white;">
            <h6 class="fw-bold m-0">Active Sprints</h6>
           
            <div class="d-flex gap-3 ">
                @* <div class="d-flex align-items-center">
                    <span class="badge badge-tall bg-light text-dark">@projectSprints.Count</span>
                </div> *@
                @if (projectSprints.Count == 0)
                {
                    <button class="btn btn-sm btn-light"
                    style=" width:25px; height:25px; border-radius:50%; padding:0;"
                    @onclick="ShowSprintCreateForm"> 
                        <i class="bi bi-plus-lg"></i>
                    </button>
                }
                else
                {
                    <button class="btn btn-sm btn-light"
                            style=" width:25px; height:25px; border-radius:50%; padding:0;"
                            @onclick="()=>OpenSprintEdit(projectSprints.First())">
                        <i class="bi bi-pencil"></i>
                    </button>
                }
            </div>
        </div>


        <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
            @foreach (var s in projectSprints)
            {
                <div class="p-3 d-flex justify-content-between align-items-start">
                        <div>
                    <div class="fw-semibold">@s.Name</div>

                    <div class="text-muted small">
                        @s.StartDate.ToString("MMM dd") - @s.EndDate.ToString("MMM dd, yyyy")
                    </div>

             

                    <span class="badge mt-2
                                @(s.Status == "Active" ? "bg-success"
                                                        : s.Status == "Planning" ? "bg-info"
                                                        : "bg-secondary")">
                    @s.Status
                </span>
            </div>
            <button type="button" class="btn btn-sm delete-circle-btn mt-0" @onclick="()=> OpenDeleteSprintConfirm(s.Id)">  <span>-</span></button>
           
            </div>
            @if (s != projectSprints.Last())
                {
                    <hr class="m-0" />
                }
            }
        </div>
    </div>

     @if (showSprintCreateForm)
     {

    <div class="mt-4">
        <AddSprint  ProjectId="@ProjectId" OnSaved="HandleSprintSaved" OnCancel="HandleSprintCancelled" />
    </div>
}
@if (showSprintEditForm)
{
    <EditSprintcomponent SprintToEdit="@sprintToEdit"
                OnUpdated="HandleSprintUpdated"
                OnCancel="CancelSprintEdit" />

                
    
}

</div>
@if (showDeleteSprintConfirm)
{
    <div class="modal-backdrop-custom"></div>

    <div class="custom-modal">
        <div class="custom-modal-header">
            <h5 class="m-0 fw-bold">Delete Sprint</h5>
            <button class="btn-close" @onclick="CloseDeleteSprintConfirm"></button>
        </div>

        <div class="custom-modal-body">
            <p class="text-dark">
                Are you sure you want to delete this sprint?
            </p>
        </div>

        <div class="custom-modal-footer">
            <button class="btn btn-secondary" @onclick="CloseDeleteSprintConfirm">
                Cancel
            </button>

            <button class="btn deletebtn" @onclick="DeleteSprintConfirm">
                Delete
            </button>
            
        </div>
    </div>
}



<div class="d-grid gap-4 mb-4 mt-4"
     style="grid-template-columns: 2fr 1fr; align-items:start;">
<div class="card shadow-sm  rounded-4 mb-4" style="min-width: 850px;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center px-3 py-1 rounded-top"
         style="background: linear-gradient(135deg, #283048, #859398);
 color:white;">
        <h6 class="fw-bold m-0">Boards</h6>
        <div class="d-flex gap-3 ">
            <div class="d-flex align-items-center">
                <span class="badge badge-tall bg-light text-dark">@Boards.Count</span>
            </div>
            <button class="btn btn-sm btn-light"
                    style=" width:25px; height:25px; border-radius:50%; padding:0;"
                     @onclick="ShowAddBoardForm" >
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
       
    </div>

      @if (Boards.Count == 0)
    {
        <div class="text-center text-muted mt-5">
            <i class="bi bi-kanban fs-1 mb-3 d-block"></i>
            <h5>No boards yet</h5>
            @* <p class="small">Click <strong>"New Board"</strong> to create your first board.</p> *@
        </div>
    }
    else
    {
       
        <div class="d-flex flex-nowrap gap-3 overflow-auto">
            @foreach (var board in Boards)
            {
              
                <div class="kanban-column bg-white rounded-4 shadow-sm p-3 flex-shrink-0" style="width: 270px;">
                   
                     
                     
                    <div class="d-flex justify-content-between align-items-center mb-3">
                            @if (editingBoardId == board.Id)
                            {
                                <input class="form-control form-control-sm"
                                       style="width:130px;"
                                       @bind="editingBoardName"
                                       @bind:event="oninput"
                                       @onblur="() => SaveBoardName(board)"
                                       @onkeydown="(e =>OnBoardNameKeyDown(e, board))" />
                            }
                            else
                            {
                                <h6 class="fw-bold" @onclick="() => StartEditingBoard(board)">
                                    @board.Name
                                </h6>
                            }

                        <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-sm delete-btn" style="color:#2c3e50;"
                                @onclick="() => OpenDeleteBoardConfirm(board)">
                                <i class="bi  bi-x-lg fs-5"></i>
                        </button>
                        <span class="badge bg-secondary">@board.TaskItems.Count task@(board.TaskItems.Count > 1 ? "s" : "")</span>
                        </div>
                    </div>
                    <hr class="border border-dark">
                    <div class="kanban-dropzone"
                         @ondragover="OnTaskDragOver"
                         @ondragover:preventDefault
                         @ondrop="@(e => OnTaskDropToEmpty(e, board))" @ondrop:stopPropagation
                         >
                    <div class="kanban-tasks">
                        @foreach (var task in board.TaskItems.OrderBy(t=>t.Order))
                        {
                                    <div class="task-card bg-light rounded-3 p-3 mb-3 shadow-sm @GetPriorityBorder(task.Priority)"
                                    role="button"
                                    tabindex="0"
                                 draggable="true"
                                 @onclick="()=>OpenTaskDetailsAsync(task.Id)"
                                
                                  @ondragstart="(e) => OnTaskDragStart(e, board, task)"
                               
                                 @ondrop="(e) => OnTaskDrop(e, board, task)" @ondrop:preventDefault
                                     @ondrop:stopPropagation>
                               <div class="d-flex justify-content-between ">
                                    
                                        <h6 class="fw-semibold mb-1 task-title">@task.Title</h6>

                                    <div class="dropdown" data-bs-auto-close="false" @onclick:stopPropagation @onmousedown:stopPropagation>
                                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" >
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>

                                            <ul class="dropdown-menu shadow rounded-3">

                                                <!-- ASSIGN USERS -->
                                                <li class="dropdown-submenu">
                                                    <a class="dropdown-item dropdown-toggle">
                                                        <i class="bi bi-person-plus me-2"></i>Members
                                                    </a>
                                                        <ul class="dropdown-menu dropdown-submenu-menu p-2 bg-light" style="width:150px;">
                                                            <div class="fw-semibold small mb-2">Select Members</div>

                                                            @foreach (var user in members)
                                                            {
                                                                <div class="form-check mb-1">
                                                                    <input class="form-check-input"
                                                                           type="checkbox"
                                                                           value="@user.Id"
                                                                           checked="@IsUserAssigned(task, user.Id)"
                                                                           @onchange="(e) => ToggleMemberSelection(task, user.Id, e.Value)">
                                                                    <label class="form-check-label">
                                                                        @user.Name
                                                                    </label>
                                                                </div>
                                                            }

                                                          @*   <button class="btn btn-sm mt-2 w-100"
                                                                    @onclick="() => SaveMultiMemberAssignment(task)" style="background-color:#2c3e50;color:white">
                                                                Save
                                                            </button> *@
                                                        </ul>
                                                 
                                                </li>

                                              

                                            </ul>
                                </div>
                              </div>
                           

                                        @if (task.TaskAssignments != null && task.TaskAssignments.Any())
                                        {

                                            var assignedMembers = members
                                            .Where(m => task.TaskAssignments.Any(a => a.AppUserId == m.Id))
                                            .ToList();


                                            <div class="task-avatar-stack mt-2">



                                                @foreach (var mem in assignedMembers.Take(3))
                                                {

                                                    <div class="task-avatar" title="@mem.Name">
                                                        @GetInitials(mem.Name)
                                                    </div>
                                                }


                                                @if (assignedMembers.Count > 3)
                                                {

                                                    <div class="task-avatar">
                                                        +@(assignedMembers.Count - 3)
                                                    </div>

                                                }

                                            </div>
                                        }
                                        else
                                        {
                                            <div class="fw-normal">0 members </div>
                                        }


                                        <div>

                                            @* @if (!string.IsNullOrWhiteSpace(task.Description))
                                            {
                                                bool showPreview = task.Description.Length > 20;

                                                <!-- Description -->
                                            @if (expandedDescriptions.Contains(task.Id))
                                            {
                                                <p class="text-muted small mt-1 description-expanded">
                                                    @task.Description
                                                </p>
                                            }
                                            else
                                            {
                                                <p class="text-muted small mt-1"
                                                   style="
                                                  max-height: 40px;
                                                  overflow: hidden;
                                                  display: -webkit-box;
                                                 -webkit-line-clamp: 1;
                                                   -webkit-box-orient: vertical;">
                                                    @task.Description
                                                </p>
                                            }
                                                @if (showPreview)
                                                {
                                            <button class="desc-toggle-btn"
                                                    @onclick="() => ToggleDescription(task)"
                                                    @onclick="stopPropagation"
                                                    @onmousedown:stopPropagation">
                                                @(expandedDescriptions.Contains(task.Id) ? "Hide Description ↑" : "Preview ↓")
                                            </button>
                                            }
                                            }
                                            else
                                            {
                                                 <div class="task-no-desc-gap"></div> <!-- ⭐ ADD THIS -->
                                                  } *@

                                        </div>


                             
                                        @if (task.IsCompleted)
                                        {
                                            <small class="text-success fw-semibold">
                                                Completed: @task.CompletedDate?.ToString("MMM dd")
                                            </small>
                                        }
                                        else
                                        {
                                            if (task.DueDate.HasValue && task.DueDate.Value.Date < DateTime.Today)
                                            {
                                                <small class="text-danger fw-bold">
                                                    Overdue: @task.DueDate?.ToString("MMM dd")
                                                </small>
                                            }
                                            else
                                            {
                                                <small class="text-warning fw-semibold">
                                                    Due: @task.DueDate?.ToString("MMM dd")
                                                </small>
                                            }
                                        }
                                

                                    
                                <div class="task-actions">
                                <div class="d-flex justify-content-end gap-2 mt-2">
                                    <button class="btn btn-sm btn-outline-primary" @onclick="()=>OpenUpdateTaskModal(board,task)" 
                                          @onclick:stopPropagation @onmousedown:stopPropagation><i class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => OpenTaskDeleteConfirm(board, task)" @onclick:stopPropagation
                                                        @onmousedown:stopPropagation>
                                                    
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                </div>
                            
                            </div>
                           
                        }
                        </div>
                        </div>


                    <!-- Add Task -->
                    <button class="btn btn-outline-secondary w-100 border-dashed mt-2" @onclick="() => OpenAddTaskModal(board)">
                        <i class="bi bi-plus-lg"></i> Add Task
                    </button>

                </div>


            }
        </div>
    }


    </div>
  
    @if (showTaskDetailsModal && selectedTaskForDetails != null)
    {
        <div class="modal-backdrop-custom" @onclick="CloseTaskDetails"></div>

        <div class="custom-modal" style="width:90%; max-width:1200px;">
            <!-- HEADER -->
            <div class="custom-modal-header">
                <div>
                    <h5 class="fw-bold mb-1">@selectedTaskForDetails.Title</h5>

                    <div class="text-muted small d-flex gap-3">
                        <span><strong>ID:</strong> TASK-@selectedTaskForDetails.Id</span>



                        <span>
                            <strong>Due:</strong>
                            @selectedTaskForDetails.DueDate?.ToString("MMM dd, yyyy")
                        </span>

                        <span class="badge rounded-pill px-3 py-2  @GetStatusBadgeClass(selectedTaskForDetails.BoardName)">
                            <strong>Status:</strong>
                            @(selectedTaskForDetails.BoardName)
                        </span>
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-3">

                <span class="badge rounded-pill text-dark px-3 py-2  @GetPriorityBadgeClass(selectedTaskForDetails.Priority)">
                   
                     @selectedTaskForDetails.Priority?.ToUpper()
                     <span>PRIORITY</span>
                </span>

                <button class="btn-close " @onclick="CloseTaskDetails"></button>
                </div>
            </div>

            <!-- BODY -->
            <div class="custom-modal-body">
                <div class="row g-4">

                    <!-- LEFT : col-8 -->
                    <div class="col-lg-8">

                        <!-- DESCRIPTION -->
                        <!-- DESCRIPTION -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-start gap-2 align-items-center mb-2">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-card-text me-2"></i>Description
                                </h6>

                                <button class="btn btn-sm btn-light"
                                        title="Edit description"
                                        @onclick="StartEditDescription">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </div>

                            <div class="bg-light rounded-3 p-3">

                                @if (isEditingDescription)
                                {
                                    <textarea class="form-control mb-2"
                                              rows="4"
                                              @bind="editedDescription"
                                              placeholder="Add description...">
                    </textarea>

                                    <div class="d-flex justify-content-end gap-2">
                                        <button class="btn btn-sm btn-secondary"
                                                @onclick="CancelEditDescription">
                                            Cancel
                                        </button>

                                        <button class="btn btn-sm savebtn"
                                                @onclick="SaveDescriptionAsync">
                                            Save
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    @if (string.IsNullOrWhiteSpace(selectedTaskForDetails.Description))
                                    {
                                        <span class="text-muted fst-italic">
                                            No description. Click ✏️ to add one.
                                        </span>
                                    }
                                    else
                                    {
                                        <p class="mb-0">
                                            @selectedTaskForDetails.Description
                                        </p>
                                    }
                                }

                            </div>
                        </div>


                        <!-- ATTACHMENTS -->
                        <div class="mb-4">

                            <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-paperclip me-2"></i>Attachments
                            </h6>
                            <InputFile OnChange="OnAttachmentSelected" class="form-control form-control-sm" style="width:220px;"/>
                            </div>
                            @if (selectedTaskForDetails.TaskAttachments?.Any() == true)
                            {
                                <div class="d-flex gap-3 flex-wrap">
                                    @foreach (var file in selectedTaskForDetails.TaskAttachments)
                                    {
                                        var fileUrl=GetFileUrl(file.FilePath);


                                    <div class="attachment-card position-relative">
            
            <!-- DELETE BUTTON (TOP-RIGHT) -->
                            <button class="btn btn-sm btn-light delete-attachment-btn"
                                   title="Delete"
                                  @onclick:stopPropagation
                                       @onclick:preventDefault
                                @onclick="() => DeleteAttachment(file.Id)">
                            <i class="bi bi-x-lg text-danger"></i>
                                       </button>
                                        <a href="@fileUrl" target="_blank"
                                           class="border rounded-3 p-3 d-flex gap-2 align-items-center text-decoration-none attachment-box">

                                            @if (file.ContentType?.StartsWith("image") == true)
                                            {
                                                @* <img src="@fileUrl"
                                                     style="width:100px;border-radius:6px;" /> *@
                                                <i class="bi bi-file-earmark-image fs-3 text-success"></i>
                                            }
                                            else if (file.ContentType == "application/pdf")
                                            {
                                                <i class="bi bi-file-earmark-pdf fs-3 text-danger"></i>
                                            }
                                            else if (file.ContentType == "application/msword" ||
                                            file.ContentType == "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
                                            {
                                                <i class="bi bi-file-earmark-word fs-3 text-primary"></i>
                                            }
                                            else if (file.ContentType == "application/vnd.ms-excel" ||
                                            file.ContentType == "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
                                            {
                                                <i class="bi bi-file-earmark-excel fs-3 text-success"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-file-earmark fs-3 text-secondary"></i>
                                            }

                                            <div style="width:200px;">
                                                <div class="fw-semibold filename-clamp">@file.FileName</div>
                                                <small class="text-muted">
                                                    @file.UploadedOn.ToString("MMM dd, yyyy")
                                                </small>
                                            </div>
                                         

                                        </a>
                                        </div>
                                      
                                    }
                                </div>
                            }

                            else
                            {
                                <div class="text-muted small">
                                    No attachments yet.
                                </div>
                            }
                        </div>

                      
                        <!-- COMMENTS -->
                        <div class="commenttext">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-chat-dots me-2"></i>Comments
                            </h6>
                            <div >
                            @if (selectedTaskForDetails.TaskComments?.Any() == true)
                            {
                                @foreach (var c in selectedTaskForDetails.TaskComments)
                                {
                                    <div class="border rounded-3 p-3 mb-2">
                                        <div class="d-flex justify-content-between ">
                                            <div class="d-flex justify-content-start align-items-center gap-1">
                                            <div class="rounded-circle  text-white fw-bold
                                        d-flex align-items-center justify-content-center"
                                                 style=" background:#2c3e50;width:36px;height:36px;flex-shrink:0;">
                                                @GetInitials(c.CreatedByUserName)
                                            </div>
                                          
                                            <strong>@c.CreatedByUserName</strong>
                                            </div>
                                            <small class="text-muted">
                                                @c.CreatedOn.ToLocalTime()
                                                
                                            </small>
                                        </div>

                                        <p class="mb-0 mt-1">
                                            @c.CommentText
                                        </p>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-muted small">
                                    No comments yet.
                                </div>
                            }
                            </div>
                        </div>
                        <div class="border rounded-3 p-3 mt-3 bg-light">
                            <textarea class="form-control mb-2"
                                      rows="2"
                                      placeholder="Write a comment..."
                                      @bind="newCommentText">
            </textarea>

                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm cmt-btn"
                                       
                                        @onclick="AddCommentAsync">
                                    <i class="bi bi-send me-1"></i> Add Comment
                                </button>
                            </div>
                           </div>
                        </div>
                       

                    <!-- RIGHT : col-4 -->
                    <div class="col-lg-4">

                        <!-- TASK DETAILS -->
                        @* <div class="card shadow-sm rounded-4 mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-info-circle me-2"></i>Task Details
                                </h6>

                                <div class="row small">
                                    <div class="col-6 text-muted">Created:</div>
                                    <div class="col-6 fw-semibold">May 3, 2023</div>

                                    <div class="col-6 text-muted mt-2">Updated:</div>
                                    <div class="col-6 fw-semibold mt-2">May 18, 2023</div>

                                    <div class="col-6 text-muted mt-2">Estimate:</div>
                                    <div class="col-6 fw-semibold mt-2">60 hrs</div>

                                    
                                </div>
                            </div>
                        </div> *@
                        @if (selectedTaskForDetails != null)
                        {
                            <div class="card shadow-sm rounded-4 mb-4">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3">
                                        <i class="bi bi-info-circle me-2"></i>Task Details
                                    </h6>

                                    <div class="row small">
                                        <div class="col-6 text-muted">CreatedOn:</div>
                                        <div class="col-6 fw-semibold">
                                            @selectedTaskForDetails.CreatedOn?.ToString("MMM dd, yyyy")
                                                                 

                                            
                                        </div>

                                        <div class="col-6 text-muted mt-2">Last UpdatedOn:</div>
                                        <div class="col-6 fw-semibold mt-2">
                                            @selectedTaskForDetails.LastUpdatedOn?.ToString("MMM dd, yyyy")
                                            
                                        </div>

                                        @* <div class="col-6 text-muted mt-2">Estimate:</div>
                                        <div class="col-6 fw-semibold mt-2">
                                            @(selectedTaskForDetails.EstimatedHours != null
                                                                                ? $"{selectedTaskForDetails.EstimatedHours} hrs"
                                                                                : "—")
                                        </div> *@
                                    </div>
                                </div>
                            </div>
                        }


                        <!-- PROJECT -->
                        @* <div class="card shadow-sm rounded-4 mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-folder me-2"></i>Project
                                </h6>

                                <p class="fw-semibold mb-1">@CurrentProject.Name</p>
                                <small class="text-muted">Backend Development</small>

                                <div class="mt-3">
                                    <span class="badge bg-secondary me-1">Backend</span>
                                    <span class="badge bg-secondary me-1">API</span>
                                    <span class="badge bg-secondary">Security</span>
                                </div>
                            </div>
                        </div> *@

                        <!-- PEOPLE -->
                        <div class="card shadow-sm rounded-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-people me-2"></i>People
                                </h6>

                                <!-- ASSIGNED TO -->
                                <div class="mb-4">
                                    <div class="fw-semibold text-muted small mb-2">
                                        Assigned To
                                    </div>

                                    @if (selectedTaskForDetails.TaskAssignments?.Any() == true)
                                    {
                                        <div class="row">
                                        @foreach (var a in selectedTaskForDetails.TaskAssignments)
                                        {
                                            var mem = members.FirstOrDefault(m => m.Id == a.AppUserId);
                                            if (mem != null)
                                            {
                                                <div class="col-6 mb-2">
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="rounded-circle text-white fw-bold
                                                         d-flex align-items-center justify-content-center"
                                                         style=" background:#2c3e50; width:36px;height:36px;">
                                                        @GetInitials(mem.Name)
                                                    </div>

                                                    <div class="ms-3">
                                                        <div class="fw-semibold">@mem.Name</div>
                                                    </div>
                                                </div>
                                                </div>
                                            }
                                        }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">No members assigned</span>
                                    }
                                </div>

                                <hr />

                                <!-- CREATED BY -->
                                <div>
                                    <div class="fw-semibold text-muted small mb-2">
                                        Created By
                                    </div>

                                    @* @if (selectedTaskForDetails.CreatedByUserId != 0)
                                    {
                                        var creator = members.FirstOrDefault(m =>
                                        m.Id == selectedTaskForDetails.CreatedByUserId);

                                        if (creator != null)
                                        {
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-secondary text-white fw-bold
                                                 d-flex align-items-center justify-content-center"
                                                     style="width:36px;height:36px;">
                                                    @GetInitials(creator.Name)
                                                </div>

                                                <div class="ms-3">
                                                    <div class="fw-semibold">@creator.Name</div>
                                                    <small class="text-muted">Task Creator</small>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">Unknown creator</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Creator not available</span>
                                    } *@
                                </div>
                            </div>
                        </div>


                    </div>

                </div>
            </div>
        </div>
    
    }

        @if (showAddBoard)
        {
            <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center" style="z-index:1050;">
                <EditForm Model="@boardModel" OnValidSubmit="ConfirmAddBoard">
                    <DataAnnotationsValidator />
                    <div class="bg-white rounded-4 shadow-lg p-4" style="width:400px;">
                        <h5 class="fw-bold mb-3 text-center">Add New Board</h5>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Board Name<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="boardModel.Name" placeholder="Enter board name" />
                            <ValidationMessage For="@(() => boardModel.Name)" />
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <button class="btn btn-outline-secondary" @onclick="CancelAddBoard">Cancel</button>
                            <button class="btn btn-board savebtn">Add Board</button>
                        </div>
                    </div>
                </EditForm>
            </div>
        }
            @if (showDeleteBoardConfirm)
    {
        <div class="modal-backdrop-custom"></div>

        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="m-0 fw-bold">Delete Board</h5>
                <button class="btn-close" @onclick="CloseDeleteBoardConfirm"></button>
            </div>

            <div class="custom-modal-body">
                <p class="text-dark">
                    Are you sure you want to delete the board <strong>@boardToDelete?.Name</strong>?
                    All tasks inside this board will also be removed.
                </p>
            </div>

            <div class="custom-modal-footer">
                <button class="btn btn-secondary" @onclick="CloseDeleteBoardConfirm">Cancel</button>
                <button class="btn deletebtn" @onclick="DeleteBoardConfirmed">Delete</button>
            </div>
        </div>
    }




     <div class="card shadow-sm  rounded-4"
         style="min-width: 200px; grid-row: span 2;">

        <div class="d-flex justify-content-between align-items-center px-3 py-1 rounded-top"
             style="background: linear-gradient(135deg, #283048, #859398);
 color:white;">
            <h6 class="fw-bold m-0">Members</h6>
            <div class="d-flex gap-3 ">
                <div class="d-flex align-items-center">
                    <span class="badge badge-tall bg-light text-dark">@members.Count</span>
                </div>
                <button class="btn  btn-light"
                        style=" width:25px; height:25px; border-radius:50%; padding:0;"
                        @onclick="showMembermodel">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>


        <div class="card-body p-0" style="max-height: 360px; overflow-y: auto;">
            @foreach (var mem in members)
            {
                

                <div class="d-flex align-items-center justify-content-between  px-3 py-2 ">
                    <div class="d-flex align-items-center">
                    <div class="rounded-circle   me-3 d-flex align-items-center justify-content-center"
                             style="width:25px; height:25px; border:1px solid #283048" >

                        <span class="fw-bold fs-8">@GetInitials(mem.Name)</span>
                    </div>


                        <div class=" fw-semibold  fs-6 me-2">@mem.Name</div>
                        </div>
                 
                        <button type="button"
                            class="btn btn-sm deletemember-circle-btn d-flex align-items-center" 
                        @onclick="() => OpenDeleteMemberConfirm(mem.Id)">
                            <span>-</span>
                        </button>

                    </div>
                    
                

               

                @if (mem != members.Last())
                {
                    <hr class="m-0" />
                }
            }
        </div>
    </div>
</div>
    @if (showMemberModel)
    {
        <div class="modal-overlay d-flex justify-content-center align-items-center">
            <div class="modal-content shadow-lg rounded-4 p-4"
                 style="width: 500px; background-color:#ecf0f1;">

                <h5 class="fw-bold mb-3 text-center" style="color:#2c3e50;">
                    Select Team Members
                </h5>

             
                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">
                        Choose Members
                    </label>
                    <div  class="d-flex align-items-center gap-2">
                    <select class="form-select w-75"
                            @bind="selectedMemberId" @key="selectedMemberId">
                        <option value="0" disabled selected hidden>Select  members</option>

                        @foreach (var m in allMembers)
                        {
                            <option value="@m.Id">@m.Name</option>
                        }
                    </select>
                  
                
                 <button type="button" class="add-btn" @onclick="ShowAddForm"> <Span class="plus mb-1">+</Span></button>
                 </div>
                  @if (!string.IsNullOrEmpty(memberError))
                    {
                        <div class="text-danger mt-1">@memberError</div>
                    }
                 </div>
                <button class="btn btn-primary mb-3 "
                        style="background-color:#2c3e50;"
                        @onclick="AddMember">
                    Add Member

                </button>

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">
                        Selected Members:
                    </label>

                    @if (selectedMembers.Count == 0)
                    {
                        <div class="text-muted">No members selected</div>
                    }
                    else
                    {
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var m in selectedMembers)
                            {
                                <span class="tag-item">
                                    @m.Name
                                    <button type="button" class="remove-tag"
                                            @onclick="() => RemoveMember(m.Id)">
                                        ×
                                    </button>
                                </span>
                            }
                        </div>
                    }
                </div>

               
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-secondary"
                            @onclick="() => showMemberModel = false">
                        Cancel
                    </button>

                    <button class="btn savebtn"
                            
                            @onclick="SaveSelection"  >
                        Save Selection
                    </button>
                </div>
                 

            </div>
        </div>
    }
    
    @if (showDeleteMemberConfirm)
    {
        <div class="modal-backdrop-custom"></div>

        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="m-0 fw-bold">Confirm Delete</h5>
                <button class="btn-close" @onclick="CloseDeleteMemberConfirm"></button>
            </div>

            <div class="custom-modal-body">
                <p class="text-dark">
                    Are you sure you want to remove this member from the project?
                </p>
            </div>

            <div class="custom-modal-footer">
                <button class="btn btn-secondary" @onclick="CloseDeleteMemberConfirm">
                    Cancel
                </button>

                <button class="btn deletebtn" @onclick="DeleteMemberConfirmed">
                    Remove
                </button>
            </div>
        </div>
    }
    
   
@if (showForm)
{
    <div class="modal-overlay">
        <div class="modal-content shadow-lg rounded-4 p-4 bg-white">
            <!-- Header -->
            <h5 class="fw-bold mb-3 text-center" style="color:#2c3e50;">
                <i class="bi @(currentUser.Id == 0 ? "bi-person-plus" : "bi-pencil-square") me-2"></i>
                @(currentUser.Id == 0 ? "Add Member" : "Edit Member")
            </h5>

            <!-- Form -->
            <EditForm Model="@currentUser" OnValidSubmit="SaveUser">
                <DataAnnotationsValidator />

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">Full Name<span class="text-danger">*</span></label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-0" style="background-color:#ecf0f1;">
                            <i class="bi bi-person-fill"></i>
                        </span>
                        <InputText class="form-control border-0 shadow-sm" style="background-color:#ecf0f1;"
                                   @bind-Value="currentUser.Name" placeholder="Enter  name" />
                    </div>
                    <ValidationMessage For="@(() => currentUser.Name)" class="text-danger small" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold" style="color:#2c3e50;">Email Address<span class="text-danger">*</span></label>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light border-0" style="background-color:#ecf0f1;">
                            <i class="bi bi-envelope-fill"></i>
                        </span>
                        <InputText type="email" class="form-control border-0 shadow-sm" style="background-color:#ecf0f1;"
                                   @bind-Value="currentUser.Email" placeholder="Enter email" />
                    </div>
                    <ValidationMessage For="@(() => currentUser.Email)" class="text-danger small" />
                </div>
                @if (!string.IsNullOrWhiteSpace(serverError))
                {
                    <div class="text-danger small mt-1">@serverError</div>
                }


                <!-- Buttons -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background-color:#2c3e50;">
                         Save
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
}
 @if (showTaskModal)
    {
        <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center" style="z-index:1050;">
            <div class="bg-white rounded-4 shadow-lg p-4" style="width:400px;">
                <h5 class="fw-bold mb-3 text-center">Add New Task</h5>
          <EditForm Model="newTask" OnValidSubmit="ConfirmAddTask">
                <DataAnnotationsValidator />
                <div class="mb-3">
                    <label class="form-label fw-semibold">Title<span class="text-danger">*</span></label>
                    <InputText class="form-control" @bind-Value="newTask.Title" placeholder="Enter task title" />
                        <ValidationMessage For="@(() => newTask.Title)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Description</label>
                    <InputTextArea class="form-control" rows="3" @bind-Value="newTask.Description" placeholder="Enter task details..."></InputTextArea>
                        <ValidationMessage For="@(() => newTask.Description)" />
                    
                </div>

                <div class="mb-3">

                    <label class=" form-label fw-semibold">Priority<span class="text-danger">*</span></label>
                    <InputSelect class="form-select" @bind-Value="newTask.Priority">
                            <option value="">-- Select Priority --</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </InputSelect>
                        <ValidationMessage For="@(() => newTask.Priority)" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Due Date<span class="text-danger">*</span></label>
                    <InputDate class="form-control" @bind-Value="newTask.DueDate" />
                        <ValidationMessage For="@(() => newTask.DueDate)" />
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-secondary" @onclick="CancelAddTask">Cancel</button>
                    <button class="btn savebtn" type="submit">Add Task</button>
                </div>
                </EditForm>
            </div>
            
        </div>
        }

        @if (showUpdateTaskModal)
        {
            <div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50
                    d-flex align-items-center justify-content-center" style="z-index:1050;">
                <div class="bg-white rounded-4 shadow-lg p-4" style="width:400px;">

                    <h5 class="fw-bold mb-3 text-center">Update Task</h5>

                    <EditForm Model="@editTask" OnValidSubmit="ConfirmUpdateTask">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Title<span class="text-danger">*</span></label>
                            <InputText class="form-control" @bind-Value="editTask.Title" />
                            <ValidationMessage For="@(() => editTask.Title)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Description</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="editTask.Description" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Priority<span class="text-danger">*</span></label>
                            <InputSelect class="form-select" @bind-Value="editTask.Priority">
                                <option value="">-- Select Priority --</option>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </InputSelect>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Due Date<span class="text-danger">*</span></label>
                            <InputDate class="form-control" @bind-Value="editTask.DueDate" />
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button class="btn btn-outline-secondary" @onclick="CloseUpdateTaskModal">Cancel</button>
                            <button class="btn savebtn" type="submit">Update</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        }
         @if (showTaskDeleteConfirm)
    {
        <div class="modal-backdrop-custom"></div>

        <div class="custom-modal">
            <div class="custom-modal-header">
                <h5 class="m-0 fw-bold">Confirm Delete</h5>
                <button class="btn-close" @onclick="CloseTaskDeleteConfirm"></button>
            </div>

            <div class="custom-modal-body">
                <p class="text-dark">
                    Are you sure you want to delete this task?
                </p>
            </div>

            <div class="custom-modal-footer">
                <button class="btn btn-secondary" @onclick="CloseTaskDeleteConfirm">
                    Cancel
                </button>

                <button class="btn deletebtn" @onclick="DeleteTaskConfirmed">
                    Delete
                </button>
            </div>
        </div>
    }

@code {

    [Parameter]
    public int ProjectId { get; set; }
    private ProjectDto CurrentProject = new();
    private List<BoardDto> Boards = new();
    private List<SprintDto> projectSprints = new();

    private List<ManagerDto> allManagers = new();
    private List<ManagerDto> managers = new();
    private List<MemberDto> members = new();
    private bool showManagerModal = false;
    private List<ManagerDto> selectedManagers = new();
    private int selectedManagerId;
    public string? managerError;
    private bool showDeleteManagerConfirm = false;
    private int managerToDelete;
    private  bool isAdmin = false;
    private  bool isManager = false;
    private  bool isMember = false;
    private bool showSprintCreateForm = false;
    private bool showSprintEditForm = false;
    private SprintDto? sprintToEdit;
    private int sprintToDelete = 0;
    private bool showDeleteSprintConfirm = false;
    private bool showAddBoard = false;
    private BoardDto boardModel = new BoardDto();
    private int editingBoardId = 0;
    private string editingBoardName = "";
    private TaskItemDto draggedTask;
    private BoardDto draggedFromBoard;
    private BoardDto boardToDelete;
    private bool showDeleteBoardConfirm = false;
    private HashSet<int> expandedDescriptions = new();
    private bool showTaskDeleteConfirm = false;
    private TaskItemDto taskToDelete;
    private BoardDto boardOfTaskToDelete;
    private BoardDto? editTaskBoard;
    private TaskItemDto? taskToEdit;
    private bool showUpdateTaskModal = false;
    private TaskItemDto editTask = new();
    private List<MemberDto> allMembers = new();
    private List<MemberDto> selectedMembers = new();
    private int selectedMemberId;
    private string? memberError;
    private bool showMemberModel = false;
    private bool showDeleteMemberConfirm = false;
    private int memberToDelete;
    private AppUserDto currentUser = new();
    private bool showForm = false;
    private string? serverError;
     private BoardDto? selectedBoard;
    private TaskItemDto newTask = new();
    private bool showAddTaskModal = false;
    private bool showTaskModal= false;
    private TaskItemDto? selectedTaskForDetails;
    private bool showTaskDetailsModal = false;
    private bool isEditingDescription = false;
    private string editedDescription = "";
    private IBrowserFile? selectedAttachment;
    private TaskCommentDto newComment = new TaskCommentDto();
    private string newCommentText = string.Empty;

private string ApiBaseUrl = "https://localhost:7218"; 











    protected override async Task OnInitializedAsync()
    {
        await LoadProject();
    }

    private async Task LoadProject()
    {
        CurrentProject = await Http.GetFromJsonAsync<ProjectDto>($"api/Project/{ProjectId}");
        Boards = CurrentProject.Boards?.ToList() ?? new();
        managers = await Http.GetFromJsonAsync<List<ManagerDto>>($"api/Project/{ProjectId}/Managers") ?? new();



        var response = await Http.GetAsync($"api/sprint/project/{ProjectId}");

        if (response.IsSuccessStatusCode)
        {
            var sprintt = await response.Content.ReadFromJsonAsync<SprintDto>();
            projectSprints = sprintt != null
            ? new List<SprintDto> { sprintt }
            : new List<SprintDto>();
        }
        else
        {
            projectSprints = new List<SprintDto>();
        }

        members = await Http.GetFromJsonAsync<List<MemberDto>>($"api/Project/{ProjectId}/Members") ?? new();
    }
    private async Task LoadMembers()
    {

        allMembers = await Http.GetFromJsonAsync<List<MemberDto>>("api/Member/memberslist")
                 ?? new List<MemberDto>();

    }
   

    private async void Back()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;



        isAdmin = user.IsInRole("Admin");
        isManager = user.IsInRole("Manager");
        isMember = user.IsInRole("Member");


        if (isAdmin)
        {
            nav.NavigateTo("/dashboard");
        }
        else if (isManager)
        {
            nav.NavigateTo("/managerdashboard");
        }
        else
        {

            nav.NavigateTo("/userdashboard");
        }
    }
    private string GetFileUrl(string filePath)
    {
        if (string.IsNullOrWhiteSpace(filePath))
            return string.Empty;

        // If already absolute, return as-is
        if (filePath.StartsWith("http"))
            return filePath;

        return $"{ApiBaseUrl}{filePath}";
    }


    string GetPriorityBorder(string? priority)
    {
        if (string.IsNullOrWhiteSpace(priority))
            return "priority-low"; 

        switch (priority.Trim().ToLowerInvariant())
        {
            case "low":
                return "priority-low-border";
            case "medium":
                return "priority-medium-border";
            case "high":
                return "priority-high-border";
            default:
                return "priority-low-border"; 
        }
    }

    private void ShowAddBoardForm() => showAddBoard = true;

    private void CancelAddBoard()
    {
        showAddBoard = false;
    }
    private void StartEditingBoard(BoardDto board)
    {
        editingBoardId = board.Id;
        editingBoardName = board.Name;
    }
    private async Task OnBoardNameKeyDown(KeyboardEventArgs e, BoardDto board)
    {
        if (e.Key == "Enter")
            await SaveBoardName(board);
    }
    private async Task SaveBoardName(BoardDto board)
    {
        if (string.IsNullOrWhiteSpace(editingBoardName))
        {
            editingBoardId = 0;
            return;
        }

        if (board.Name != editingBoardName)
        {
            var dto = new BoardDto
        {
            Id = board.Id,
            Name = editingBoardName
        };
            var response = await Http.PutAsJsonAsync(
                $"api/Board/{board.Id}?projectId={ProjectId}",
                dto
            );

            if (response.IsSuccessStatusCode)
            {
                board.Name = editingBoardName;
            }
            else
            {
                Console.WriteLine("Failed to update board name!");
            }
        }

        editingBoardId = 0;
    }
    private void OpenDeleteBoardConfirm(BoardDto board)
    {
        boardToDelete=board;
        showDeleteBoardConfirm = true;
    }
    private void CloseDeleteBoardConfirm()
    {
        boardToDelete = null;
        showDeleteBoardConfirm = false;
    }

    private async Task DeleteBoardConfirmed()
    {


        var response = await Http.DeleteAsync($"api/Board/{boardToDelete.Id}?projectId={ProjectId}");
        if (response.IsSuccessStatusCode)
        {
            Boards.Remove(boardToDelete);
            // CurrentProject.Boards = Boards;



        }

        showDeleteBoardConfirm = false;
        boardToDelete = null;
    }


    private async Task ConfirmAddBoard()
    {


        var newBoard = new BoardDto
        {
            Name = boardModel.Name,

            // ProjectId = CurrentProject.Id,

        };

        // Boards.Add(newBoard);
        // CurrentProject.Boards = Boards;

        try
        {

            var response = await Http.PostAsJsonAsync($"api/Board/{ProjectId}", newBoard);


            if (response.IsSuccessStatusCode)
            {


                var responseget = await Http.GetAsync($"api/Board?projectId={ProjectId}");
                if (responseget.IsSuccessStatusCode)
                {
                    var createdBoard = await responseget.Content.ReadFromJsonAsync<List<BoardDto>>();



                    Boards = createdBoard ?? new List<BoardDto>();
                    showAddBoard = false;
                    boardModel = new BoardDto();
                    StateHasChanged();

                }
            }
            else
            {
                Console.WriteLine($"Failed to update project. Status: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error saving board: " + ex.Message);
        }
        showAddBoard = false;
        boardModel = new BoardDto();
    }
    private async Task ShowMangerModal()
    {
        allManagers = await Http.GetFromJsonAsync<List<ManagerDto>>("api/Manager/All")
        ?? new List<ManagerDto>();

        // selectedManagers = managers
        //     .Select(m => new ManagerDto { Id = m.Id, Name = m.Name })
        //     .ToList();
        showManagerModal = true;
    }

    private void AddManagerToSelection()
    {
        managerError = null;

        if (selectedManagerId == 0)
        {
            managerError = "Please select a manager before adding.";
            return;
        }
        // if (selectedManagerId == 0) return;

        var manager = allManagers.FirstOrDefault(m => m.Id == selectedManagerId);

        if (manager != null && !selectedManagers.Any(s => s.Id == manager.Id))
            selectedManagers.Add(manager);

        selectedManagerId = 0;
    }

    private void RemoveManager(int id)
    {
        var m = selectedManagers.FirstOrDefault(x => x.Id == id);
        if (m != null) selectedManagers.Remove(m);
    }

    private async Task SaveManagerSelection()
    {
        managerError = null; // reset first

        // VALIDATION: At least 1 manager must be selected
        if (selectedManagers.Count == 0)
        {
            managerError = "Please select at least one manager.";
            StateHasChanged();   // re-render modal
            return;              // STOP here → do not close modal
        }
        showManagerModal = false;

        // StateHasChanged();


        var managerIds = selectedManagers.Select(m => m.Id).ToList();

        await Http.PostAsJsonAsync(
        $"api/Manager/{ProjectId}/Manager/Assign",
        managerIds
        );

        // Refresh project
        await LoadProject();
        // StateHasChanged();
    }

    private void OpenDeleteManagerConfirm(int id)
    {
        managerToDelete = id;
        showDeleteManagerConfirm = true;
    }

    private void CloseDeleteConfirm()
    {
        showDeleteManagerConfirm = false;
    }

    private async Task DeleteManagerConfirmed()
    {
        showDeleteManagerConfirm = false;

        var response = await Http.DeleteAsync(
        $"api/Manager/RemoveFromProject?projectId={ProjectId}&managerId={managerToDelete}"
        );

        if (response.IsSuccessStatusCode)
        {
            await LoadProject();
            StateHasChanged();
        }
        else
        {
            Console.WriteLine("Failed to delete manager.");
        }
    }
    private void ShowAddForm()
    {
        currentUser = new AppUserDto
            {
                Role = "Member"

            };

        showForm = true;
    }
    private void CancelEdit()
    {
        showForm = false;
        currentUser = new();
    }

    private async Task SaveSelection()
    {
        memberError = null;
        if (selectedMembers.Count == 0)
        {
            memberError = "Please select at least one member.";
            StateHasChanged();
            return; // DO NOT close modal
        }
        showMemberModel = false;


        // StateHasChanged();

        // 4. Send to backend (optional but required for saving)
        var memberIds = selectedMembers.Select(m => m.Id).ToList();

        await Http.PostAsJsonAsync(
            $"api/Project/{ProjectId}/Members/Assign",
            memberIds
        );
        await LoadProject();
        StateHasChanged();
    }
    async Task showMembermodel()
    {
        await LoadMembers();
        showMemberModel = true;
    }


    private void AddMember()
    {
        memberError = null;

        if (selectedMemberId == 0) 
        {
            memberError = "Please select a member before adding.";
            return;
        }

        var member = allMembers.FirstOrDefault(m => m.Id == selectedMemberId);

        if (member != null && !selectedMembers.Any(s => s.Id == member.Id))
        {
            selectedMembers.Add(member);
        }

        selectedMemberId = 0;
    }

    private void RemoveMember(int id)
    {
        var m = selectedMembers.FirstOrDefault(x => x.Id == id);
        if (m != null) selectedMembers.Remove(m);
    }

    private void OpenDeleteMemberConfirm(int id)
    {
        memberToDelete = id;
        showDeleteMemberConfirm = true;
    }

    private void CloseDeleteMemberConfirm()
    {
        showDeleteMemberConfirm = false;
    }

    private async Task DeleteMemberConfirmed()
    {
        showDeleteMemberConfirm = false;

        var response = await Http.DeleteAsync(
            $"api/Member/RemoveFromProject?projectId={ProjectId}&memberId={memberToDelete}"
        );

        if (response.IsSuccessStatusCode)
        {
            await LoadProject();
            StateHasChanged();
        }
        else
        {
            Console.WriteLine("Failed to delete manager.");
        }
    }
    private async Task SaveUser()
    {
        serverError = "";

        if (string.IsNullOrWhiteSpace(currentUser.Role))
            currentUser.Role = "Member";
        if (currentUser.Id == 0)
        {

            var response = await Http.PostAsJsonAsync("api/Member", currentUser);
            if (response.IsSuccessStatusCode)
            {
                showForm = false;

                await LoadMembers();
            }
            else
            {
                serverError = await response.Content.ReadAsStringAsync();

            }
        }
    }
    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return string.Empty;

        return string.Join("", name.Split(' ', StringSplitOptions.RemoveEmptyEntries)
        .Select(n => n[0]))
        .ToUpper();
    }

       private void ToggleDescription(TaskItemDto task)
    {
        if (expandedDescriptions.Contains(task.Id))
            expandedDescriptions.Remove(task.Id);
        else
            expandedDescriptions.Add(task.Id);
    }
    private void ShowSprintCreateForm()
    {
        showSprintCreateForm = true;
    }
    private async Task HandleSprintSaved()
    {
        showSprintCreateForm = false;


        // Sprints = await Http.GetFromJsonAsync<List<SprintDto>>("api/sprint") ?? new();
        @* FilterSprints(); *@
        await LoadProject();
    }

    private Task HandleSprintCancelled()
    {
        showSprintCreateForm = false;
        return Task.CompletedTask;
    }
    private void OpenSprintEdit(SprintDto sprint)
    {
        sprintToEdit = sprint;
        showSprintEditForm = true;
    }
    private async Task HandleSprintUpdated()
    {
        showSprintEditForm = false;
        sprintToEdit = null;

        await LoadProject();
        StateHasChanged();
    }

    private void CancelSprintEdit()
    {
        showSprintEditForm = false;
        sprintToEdit = null;
    }

    private void OpenDeleteSprintConfirm(int sprintId)
    {
        sprintToDelete = sprintId;
        showDeleteSprintConfirm = true;
    }
    private void CloseDeleteSprintConfirm()
    {
        sprintToDelete = 0;
        showDeleteSprintConfirm = false;
    }
    private async Task DeleteSprintConfirm()
    {
        var response = await Http.DeleteAsync($"api/sprint/{sprintToDelete}");
        if (response.IsSuccessStatusCode)
        {
            await LoadProject();
        }
        showDeleteSprintConfirm = false;
        sprintToDelete = 0;
    }
    private void StartEditDescription()
    {
        isEditingDescription=true;
        editedDescription = selectedTaskForDetails?.Description ?? "";
    }
    private void CancelEditDescription()
    {
        isEditingDescription=false;
        editedDescription = "";
    }
    private async Task SaveDescriptionAsync()
    {
        if (selectedTaskForDetails == null)
            return;

    

        var response = await Http.PutAsJsonAsync(
            $"description/{selectedTaskForDetails.Id}",
            editedDescription
        );

        if (response.IsSuccessStatusCode)
        {
            selectedTaskForDetails.Description = editedDescription;
            isEditingDescription = false;
            // StateHasChanged();
            await OpenTaskDetailsAsync(selectedTaskForDetails.Id);

        }
        else
        {
            Console.WriteLine("Failed to update description");
        }
    }
    private string GetPriorityBadgeClass(string? priority)
    {
        return priority?.ToLowerInvariant() switch
        {
            "low" => "bg-success text-white",
            "medium" => "bg-warning text-dark",
            "high" => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }
    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "todo" => "bg-secondary text-white",
            "in progress" => "bg-primary text-white",
            "done" => "bg-success text-white",
            "review" => "bg-warning text-dark",
            _ => "bg-info text-dark"
        };
    }



    private async Task OnAttachmentSelected(InputFileChangeEventArgs e)
    {
        if (selectedTaskForDetails == null)
            return;

        selectedAttachment = e.File;

        var content = new MultipartFormDataContent();

        var streamContent = new StreamContent(
            selectedAttachment.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024)); 

        streamContent.Headers.ContentType =
            new System.Net.Http.Headers.MediaTypeHeaderValue(selectedAttachment.ContentType);

        content.Add(streamContent, "File", selectedAttachment.Name);

        

        var response = await Http.PostAsync(
            $"api/FileAndCommentInTask/{selectedTaskForDetails.Id}/attachments",
            content
        );

        

        if (response.IsSuccessStatusCode)
        {
            // var newAttachment =
            //     await response.Content.ReadFromJsonAsync<TaskAttachmentDto>();

            // if (newAttachment != null)
            // {
            //     Console.WriteLine("Attachment uploaded: " + newAttachment.FilePath);
            //     selectedTaskForDetails.TaskAttachments ??= new List<TaskAttachmentDto>();
            //     selectedTaskForDetails.TaskAttachments.Add(newAttachment);
            // }

            // StateHasChanged();

            await OpenTaskDetailsAsync(selectedTaskForDetails.Id);
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            Console.WriteLine("Upload failed: " + error);
        }
    }
    private async Task DeleteAttachment(int attachmentId)
    {
        var response = await Http.DeleteAsync(
            $"api/FileAndCommentInTask/attachments/{attachmentId}");

        if (response.IsSuccessStatusCode)
        {
            selectedTaskForDetails.TaskAttachments
                .RemoveAll(a => a.Id == attachmentId);
            await OpenTaskDetailsAsync(selectedTaskForDetails.Id);
            // StateHasChanged();
        }
    }
    private async Task AddCommentAsync()
    {
        if (string.IsNullOrWhiteSpace(newCommentText))
            return;

        var dto = new TaskCommentDto
        {
            CommentText = newCommentText,
            
        };

        var response = await Http.PostAsJsonAsync(
        $"api/FileAndCommentInTask/{selectedTaskForDetails.Id}/comments",
        dto
        );

        if (response.IsSuccessStatusCode)
        {
            newCommentText = string.Empty;

            // 🔁 Refresh task details (comments included)
            await OpenTaskDetailsAsync(selectedTaskForDetails.Id);
        }
    }

    private async Task OpenTaskDetailsAsync(int taskId)
    {
        try
        {
            var response = await Http.GetAsync($"api/FileAndCommentInTask/{taskId}");
            if(response.IsSuccessStatusCode)
            {
                selectedTaskForDetails = await response.Content.ReadFromJsonAsync<TaskItemDto>();
            


            if (selectedTaskForDetails != null)
            {
                showTaskDetailsModal = true;
            }
            }
            else
            {
                Console.WriteLine("Failed to fetch task details.");
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine("Error fetching task details: " + ex.Message);
        }
    }
    // private void OpenTaskDetails(TaskItemDto task)
    // {
    //     selectedTaskForDetails = task;
    //     showTaskDetailsModal = true;
    // }

    private void CloseTaskDetails()
    {
        showTaskDetailsModal = false;
        selectedTaskForDetails = null;
    }

    private void OpenTaskDeleteConfirm(BoardDto board,TaskItemDto task)
    {
        boardOfTaskToDelete=board;
        taskToDelete=task;
        showTaskDeleteConfirm = true;
    }
    private void CloseTaskDeleteConfirm()
    {
        showTaskDeleteConfirm=false;
        taskToDelete=null;
        boardOfTaskToDelete = null;
    }
    private async Task DeleteTaskConfirmed()
    {
        if (boardOfTaskToDelete == null || taskToDelete == null)
        {
            return;
        }
        try
        {
            var response = await Http.DeleteAsync($"api/TaskItem/tasks/{taskToDelete.Id}");
            if(response.IsSuccessStatusCode)
            {
                boardOfTaskToDelete.TaskItems.Remove(taskToDelete);
                UpdateOrderNumbers(boardOfTaskToDelete);
                StateHasChanged();

            }
            else
            {
                Console.WriteLine("Failed to delete task.");
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        showTaskDeleteConfirm = false;
        taskToDelete = null;
        boardOfTaskToDelete = null;

    }
    private void OnTaskDragStart(DragEventArgs e, BoardDto fromBoard, TaskItemDto task)
    {

        draggedTask = task;
        draggedFromBoard = fromBoard;
    }

    private void OnTaskDragOver(DragEventArgs e)
    {

    }

    private async Task OnTaskDrop(DragEventArgs e, BoardDto toBoard, TaskItemDto targetTask)
    {
        try
        {

            if (draggedTask == null||draggedFromBoard==null)
            {

                return;
            }

            var fromBoard = draggedFromBoard;


            var removeItem = fromBoard.TaskItems.FirstOrDefault(t => t.Id == draggedTask.Id);
            if (removeItem != null)
                fromBoard.TaskItems.Remove(removeItem);


            var list = toBoard.TaskItems
                .OrderBy(t => t.Order)
                .ToList();


            int targetIndex = list.FindIndex(t => t.Id == targetTask.Id);
            if (targetIndex < 0) targetIndex = list.Count;

            list.Insert(targetIndex, draggedTask);


            toBoard.TaskItems.Clear();
            foreach (var t in list)
                toBoard.TaskItems.Add(t);
            draggedTask.BoardId = toBoard.Id;

            if (toBoard.Name.Equals("Done", StringComparison.OrdinalIgnoreCase))
            {
                draggedTask.IsCompleted = true;
                draggedTask.CompletedDate = DateTime.Today;   // ⭐ Set completed date
            }
            else
            {
                draggedTask.IsCompleted =false;
                draggedTask.CompletedDate = null; // optional
            }

            NormalizeOrder(fromBoard);

            NormalizeOrder(toBoard);

            await PersistBoardOrders(fromBoard);
            await PersistBoardOrders(toBoard);

            draggedTask = null;
            draggedFromBoard = null;
        }
        catch(Exception ex)
        {
            Console.WriteLine(ex.Message);
        }


    }
    private void NormalizeOrder(BoardDto board)
    {
        int order = 1;
        foreach (var t in board.TaskItems.OrderBy(t => t.Order))
        {
            t.Order = order++;
        }

    }


    private async Task OnTaskDropToEmpty(DragEventArgs e, BoardDto toBoard)
    {


        if (draggedTask == null)
        {

            return;
        }

        var fromBoard = draggedFromBoard;
        if (fromBoard == null) return;


        var removeItem = fromBoard.TaskItems.FirstOrDefault(t => t.Id == draggedTask.Id);
        if (removeItem != null)
            fromBoard.TaskItems.Remove(removeItem);






        toBoard.TaskItems.Add(draggedTask);
        draggedTask.BoardId = toBoard.Id;

        if (toBoard.Name.Equals("Done", StringComparison.OrdinalIgnoreCase))
        {
            draggedTask.IsCompleted = true;
            draggedTask.CompletedDate = DateTime.Today;
        }
        else
        {
            draggedTask.IsCompleted = false;
            draggedTask.CompletedDate = null; // or keep old value
        }



        NormalizeOrder(fromBoard);
        NormalizeOrder(toBoard);

        await PersistBoardOrders(fromBoard);
        await PersistBoardOrders(toBoard);

        draggedTask = null;
        draggedFromBoard = null;

    }

    private void UpdateOrderNumbers(BoardDto board)
    {
        int order = 1;
        foreach (var t in board.TaskItems)
        {
            t.Order = order;
            order++;
        }
    }
    private bool IsUserAssigned(TaskItemDto task, int userId)
    {
        return task.TaskAssignments != null &&
               task.TaskAssignments.Any(a => a.AppUserId == userId);
    }


    private async Task ToggleMemberSelection(TaskItemDto task, int memberId, object value)
    {
        bool isChecked = (bool)value;

        if (task.TaskAssignments == null)
            task.TaskAssignments = new List<TaskAssignmentDto>();

        try
        
        
        
        
        {
            if (isChecked)
            {
                var resonse = await Http.PostAsJsonAsync($"api/AssignMember/{task.Id}/assign",memberId);
                if (resonse.IsSuccessStatusCode)

                {
                    if (!task.TaskAssignments.Any(a => a.AppUserId == memberId))
                    {
                        task.TaskAssignments.Add(new TaskAssignmentDto
                            {
                                AppUserId = memberId,
                                TaskItemId = task.Id
                            });
                    }
                }
            }
            else
            {
                var response = await Http.DeleteAsync($"api/AssignMember/{task.Id}/remove?memberId={memberId}");
                if (response.IsSuccessStatusCode)
                {

                    var existing = task.TaskAssignments.FirstOrDefault(a => a.AppUserId == memberId);
                    if (existing != null)
                        task.TaskAssignments.Remove(existing);
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }
    // private async Task SaveMultiMemberAssignment(TaskItemDto task)
    // {
        
    //     foreach (var board in Boards)
    //     {
    //         var t = board.TaskItems.FirstOrDefault(x => x.Id == task.Id);
    //         if (t != null)
    //         {
    //             t.TaskAssignments = task.TaskAssignments;
    //             break;
    //         }
    //     }

        
    // }

    private void OpenUpdateTaskModal(BoardDto board, TaskItemDto task)
    {
        editTaskBoard = board;


        editTask = new TaskItemDto
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            Priority = task.Priority,
            DueDate = task.DueDate,
            BoardId = task.BoardId,


            Order = task.Order,

        };

        showUpdateTaskModal = true;
    }
    private void OpenAddTaskModal(BoardDto board)
    {
        selectedBoard = board;
        newTask = new TaskItemDto
            {
                BoardId = board.Id,
            // Priority = "Low",
            // DueDate = DateTime.UtcNow.AddDays(1)

            };
        showTaskModal = true;
    }

    private void CancelAddTask()
    {
        showTaskModal = false;
        newTask = new TaskItemDto();
        selectedBoard = null;
    }
    private async Task ConfirmAddTask()
    {
        if (selectedBoard == null || string.IsNullOrWhiteSpace(newTask.Title))
            return;

             newTask.Order = selectedBoard.TaskItems.Count + 1;
        try
        {
            var response = await Http.PostAsJsonAsync($"api/TaskItem/boards/{selectedBoard.Id}/tasks", newTask); 
            if (response.IsSuccessStatusCode)
            {
                var createdTask = await response.Content.ReadFromJsonAsync<TaskItemDto>();
                if (createdTask != null)
                {
                    selectedBoard.TaskItems.Add(createdTask);
                    UpdateOrderNumbers(selectedBoard);
                }
                showTaskModal = false;
                newTask= new TaskItemDto();
                selectedBoard = null;

                StateHasChanged();
            }
            else
            {
                Console.WriteLine("Failed to create task.");
             
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error creating task: " + ex.Message);
        }
   
       
    }
      
    private async Task ConfirmUpdateTask()
    {
        if (editTaskBoard == null) return;

        var response = await Http.PutAsJsonAsync($"api/TaskItem/{editTask.Id}", editTask);

        if (response.IsSuccessStatusCode)
        {
            // Update UI
            var original = editTaskBoard.TaskItems.FirstOrDefault(t => t.Id == editTask.Id);

            if (original != null)
            {
                original.Title = editTask.Title;
                original.Description = editTask.Description;
                original.Priority = editTask.Priority;
                original.DueDate = editTask.DueDate;
                original.Order = editTask.Order;

            }

            showUpdateTaskModal = false;

            @* await SaveProject();  *@
            StateHasChanged();
        }
        else
        {
            Console.WriteLine("Task update failed!");
        }
    }

    private void CloseUpdateTaskModal()
    {
        showUpdateTaskModal = false;
    }
    private async Task PersistBoardOrders(BoardDto board)
{
     bool isDoneBoard =
        board.Name.Equals("Done", StringComparison.OrdinalIgnoreCase);
    var payload = board.TaskItems.Select(t => new TaskReorderDto
    {
        TaskId = t.Id,
        BoardId = board.Id,
        Order = t.Order,
            IsDoneBoard = isDoneBoard
    }).ToList();

    await Http.PutAsJsonAsync("api/TaskItem/tasks/reorder", payload);
}

}
