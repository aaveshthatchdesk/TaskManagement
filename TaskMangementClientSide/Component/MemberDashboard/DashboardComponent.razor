@using Task.Application.DTOs
@inject HttpClient Http
@inject NavigationManager nav

<style>
    .priority-low-border {
        border-left: 5px solid #27ae60 !important;
    }

    .priority-medium-border {
        border-left: 5px solid #f1c40f !important;
    }

    .priority-high-border {
        border-left: 5px solid #e67e22 !important;
    }

    .kanban-tasks:empty {
        min-height: 10px;
    }
    .card {
       
        border-radius: 12px !important;
        overflow: hidden; 
        box-shadow: none !important;
    }
  
    .task-card {
        /* min-height: 240px; */
        max-height:400px;/* consistent height */
        display: flex;
        flex-direction: column;
        justify-content: start;
        gap:6px;
        overflow:visible;
    }
      .add-btn {
        height: 35px;
        width: 35px; 
        border: none;
        border-radius: 4px; 
        background-color: #2c3e50;
        color: white;
         font-size:20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        
    padding: 0;  
        
    }
     .kanban-column {
        position: relative;
        overflow: visible !important;
    }

   



    .kanban-tasks {
        max-height: 60vh; /* sets a cap but allows natural shrinking */
        overflow-y: auto;
        padding-right: 6px;
    }


    

    .modal-backdrop-custom {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.45);
        z-index: 1040;
    }

   
    .custom-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        width: 420px;
        border-radius: 12px;
        overflow:hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 1050;
        padding: 0;
    }

  
    .custom-modal-header {
        padding: 15px 20px;
        background: #ffffff;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top-left-radius: 12px; /
        border-top-right-radius: 12px;
    }
 
    .custom-modal-body {
        padding: 20px;
    }

   
    .custom-modal-footer {
        padding: 12px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        border-top: 1px solid #eee;
    }


     .task-avatar-stack {
        display: flex;
        align-items: center;
    }

    .task-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #546476;
        color: white;
        font-size: 12px;

        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        margin-left: -8px; /* 👈 overlap effect */
        border: 2px solid white; /* clean ring */
    }

        .task-avatar:first-child {
            margin-left: 0;
        }


        .desc-toggle-btn {
        font-size: 12px;
        border: none;
        background: #d5dfe6;
        color: black;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

        .desc-toggle-btn:hover {
            text-decoration: underline;
        }

    .description-expanded {
        white-space: pre-line;
    }
    .task-no-desc-gap {
    margin-top: 12px;   
    display: block;
}

.task-actions {
    margin-top: auto;   
    padding-top: 8px;   
}

    .filename-clamp {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-break: break-word;
    }

    .attachment-card {
        position: relative;
    }

    .delete-attachment-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        z-index: 10;
        border-radius: 50%;
        padding: 2px 6px;
        line-height: 1;
    }

        .delete-attachment-btn:hover {
            background: rgba(220, 53, 69, 0.15);
        }

    .attachment-link {
        display: flex;
        align-items: center;
    }

    .custom-modal {
        max-height: 90vh; 
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .custom-modal-header {
        flex-shrink: 0; 
        border-bottom: 1px solid #e5e5e5;
    }

    .custom-modal-body {
        flex: 1; 
        overflow-y: auto; 
        padding: 1rem;
    }

    .attachment-box {
        width: 240px; 
        height: 80px; 
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .commenttext {
        max-height: 250px;
        overflow-y: auto;
    }

    .cmt-btn {
        background-color: #2c3e50;
        color: white;
    }

        .cmt-btn:hover {
            background-color: #22303A;
            color: white;
        }

    .savebtn {
        background-color: #2c3e50;
        color: white;
    }

        .savebtn:hover {
            background-color: #22303A;
            color: white;
        }

   
</style>

<div class="container mt-4">
    <div class="row g-4">

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm text-center py-4 " style="background-color:#ecf0f1">
                <div class="text-primary fs-3 mb-2">
                    <i class="bi bi-diagram-3"></i>
                </div>
                <h4 class="fw-bold text-dark mb-0">@stats.ActiveProjects</h4>
                <p class="text-muted mb-0">Active Projects</p>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm text-center py-4" style="background-color:#ecf0f1">
                <div class="text-primary fs-3 mb-2">
                    <i class="bi bi-clock-history"></i>
                </div>
                <h4 class="fw-bold text-dark mb-0">@stats.OverdueTasks</h4>
                <p class="text-muted mb-0">OverDue Tasks</p>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm text-center py-4" style="background-color:#ecf0f1">
                <div class="text-primary fs-3 mb-2">
                    <i class="bi bi-list-check"></i>
                </div>
                <h4 class="fw-bold text-dark mb-0">@stats.ActiveTasks</h4>
                <p class="text-muted mb-0">Active Tasks</p>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm text-center py-4" style="background-color:#ecf0f1">
                <div class="text-primary fs-3 mb-2">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <h4 class="fw-bold text-dark mb-0">@stats.CompletedTasks</h4>
                <p class="text-muted mb-0">Completed Tasks</p>
            </div>
        </div>

    </div>
</div>

 <div class="container mt-5  ">
    <div class=" p-4 rounded-4" style="background-color:#ecf0f1">
       
        <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">

            <h4 class="fw-bold mb-0 text-dark">My Tasks</h4>

         

        </div>

          @if (GroupedBoards.Count == 0)
    {
        <div class="text-center text-muted mt-auto">
            <i class="bi bi-kanban fs-1 mb-3 d-block"></i>
            <h5>No boards yet</h5>
            @* <p class="small">Click <strong>"New Board"</strong> to create your first board.</p> *@
        </div>
    }
    else
    {
       
        <div class="d-flex flex-nowrap gap-3 overflow-auto mt-4">
            @foreach (var board in GroupedBoards)
            {
              
                <div class="kanban-column bg-white rounded-4 shadow-sm p-3 flex-shrink-0" style="width: 270px;">
                   
                     
                     
                    <div class="d-flex justify-content-between align-items-center mb-3">

                        <h5>@board.Name</h5>
                      
                        <span class="badge bg-secondary">@board.TaskItems.Count task@(board.TaskItems.Count > 1 ? "s" : "")</span>
                        </div>
                 
                    <hr class="border border-dark">
                    <div class="kanban-dropzone"
                         @ondragover="OnTaskDragOver"
                         @ondragover:preventDefault
                         @ondrop="@(e => OnTaskDropToEmpty(e, board))" @ondrop:stopPropagation
                         >
                    <div class="kanban-tasks">
                        @foreach (var task in board.TaskItems.OrderBy(t=>t.Order))
                        {
                                    <div class="task-card bg-light rounded-3 p-3 mb-3 shadow-sm @GetPriorityBorder(task.Priority)"
                                    role="button"
                                    tabindex="0"
                                 draggable="true"
                                 @onclick="() => OpenTaskDetailsAsync(task.Id)"
                                  @ondragstart="(e) => OnTaskDragStart(e, board, task)"
                               
                                 @ondrop="(e) => OnTaskDrop(e, board, task)" @ondrop:preventDefault
                                     @ondrop:stopPropagation>
                               <div class="d-flex justify-content-between ">
                                    
                                        <h6 class="fw-semibold mb-1 task-title">@task.Title</h6>

                                 
                                </div>
                                <div class="text-muted small">
                                   <i class="bi bi-folder"></i> @task.ProjectName
                                        </div>


                             
                           

                                       @if (task.TaskAssignments != null && task.TaskAssignments.Any())
                                                 {
                                           <div class="task-avatar-stack mt-2">
                                               @foreach (var mem in task.TaskAssignments.Take(3))
                                                 {
                                                      <div class="task-avatar" title="@mem.AppUserName">
                                                            @GetInitials(mem.AppUserName)
                                                                </div>
                                                        }

                                               @if (task.TaskAssignments.Count > 3)
                                                 {
                                                 <div class="task-avatar">
                                                 +@(task.TaskAssignments.Count - 3)
                                                    </div>
                                                     }
                                               </div>
                                              }
                                        else
                                        {
                                            <div class="fw-normal">0 members </div>
                                        }


                                       


                             
                                        @if (task.IsCompleted)
                                        {
                                            <small class="text-success fw-semibold">
                                                Completed: @task.CompletedDate?.ToString("MMM dd")
                                            </small>
                                        }
                                        else
                                        {
                                            if (task.DueDate.HasValue && task.DueDate.Value.Date < DateTime.Today)
                                            {
                                                <small class="text-danger fw-bold">
                                                    Overdue: @task.DueDate?.ToString("MMM dd")
                                                </small>
                                            }
                                            else
                                            {
                                                <small class="text-warning fw-semibold">
                                                    Due: @task.DueDate?.ToString("MMM dd")
                                                </small>
                                            }
                                       }
                                    </div>
                          }      
                          

                        </div>
                        </div>


                    

                


            
        </div>
    }
    </div>
  }
    @if (showTaskDetailsModal && selectedTaskForDetails != null)
    {
        <div class="modal-backdrop-custom" @onclick="CloseTaskDetails"></div>

        <div class="custom-modal" style="width:90%; max-width:1200px;">
            <!-- HEADER -->
            <div class="custom-modal-header">
                <div>
                    <h5 class="fw-bold mb-1">@selectedTaskForDetails.Title</h5>

                    <div class="text-muted small d-flex gap-3">
                        <span><strong>ID:</strong> TASK-@selectedTaskForDetails.Id</span>



                        <span>
                            <strong>Due:</strong>
                            @selectedTaskForDetails.DueDate?.ToString("MMM dd, yyyy")
                        </span>

                        <span class="badge rounded-pill px-3 py-2  @GetStatusBadgeClass(selectedTaskForDetails.BoardName)">
                            <strong>Status:</strong>
                            @(selectedTaskForDetails.BoardName)
                        </span>
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-3">

                <span class="badge rounded-pill text-dark px-3 py-2  @GetPriorityBadgeClass(selectedTaskForDetails.Priority)">
                   
                     @selectedTaskForDetails.Priority?.ToUpper()
                     <span>PRIORITY</span>
                </span>

                <button class="btn-close " @onclick="CloseTaskDetails"></button>
                </div>
            </div>

            <!-- BODY -->
            <div class="custom-modal-body">
                <div class="row g-4">

                    <!-- LEFT : col-8 -->
                    <div class="col-lg-8">

                       
                        <div class="mb-4">
                            <div class="d-flex justify-content-start gap-2 align-items-center mb-2">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-card-text me-2"></i>Description
                                </h6>

                               
                            </div>

                            <div class="bg-light rounded-3 p-3">

                              
                                    @if (string.IsNullOrWhiteSpace(selectedTaskForDetails.Description))
                                    {
                                        <span class="text-muted fst-italic">
                                            No description.
                                        </span>
                                    }
                                    else
                                    {
                                        <p class="mb-0">
                                            @selectedTaskForDetails.Description
                                        </p>
                                    }
                                

                            </div>
                        </div>


                     <!-- ATTACHMENTS -->
<div class="mb-4">

    <h6 class="fw-bold mb-3">
        <i class="bi bi-paperclip me-2"></i>Attachments
    </h6>

    @if (selectedTaskForDetails.TaskAttachments?.Any() == true)
    {
        <div class="d-flex gap-3 flex-wrap">
            @foreach (var file in selectedTaskForDetails.TaskAttachments)
            {
                var fileUrl = GetFileUrl(file.FilePath);

                <a href="@fileUrl" target="_blank"
                   class="border rounded-3 p-3 d-flex gap-2 align-items-center text-decoration-none attachment-box">

                    @if (file.ContentType?.StartsWith("image") == true)
                    {
                        <i class="bi bi-file-earmark-image fs-3 text-success"></i>
                    }
                    else if (file.ContentType == "application/pdf")
                    {
                        <i class="bi bi-file-earmark-pdf fs-3 text-danger"></i>
                    }
                    else if (file.ContentType == "application/msword" ||
                             file.ContentType == "application/vnd.openxmlformats-officedocument.wordprocessingml.document")
                    {
                        <i class="bi bi-file-earmark-word fs-3 text-primary"></i>
                    }
                    else if (file.ContentType == "application/vnd.ms-excel" ||
                             file.ContentType == "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
                    {
                        <i class="bi bi-file-earmark-excel fs-3 text-success"></i>
                    }
                    else
                    {
                        <i class="bi bi-file-earmark fs-3 text-secondary"></i>
                    }

                    <div style="width:200px;">
                        <div class="fw-semibold filename-clamp">@file.FileName</div>
                        <small class="text-muted">
                            @file.UploadedOn.ToString("MMM dd, yyyy")
                        </small>
                    </div>
                </a>
            }
        </div>
    }
    else
    {
        <div class="text-muted small">
            No attachments yet.
        </div>
    }
</div>


                      
                        <!-- COMMENTS -->
                        <div class="commenttext">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-chat-dots me-2"></i>Comments
                            </h6>
                            <div >
                            @if (selectedTaskForDetails.TaskComments?.Any() == true)
                            {
                                @foreach (var c in selectedTaskForDetails.TaskComments)
                                {
                                    <div class="border rounded-3 p-3 mb-2">


                                           
                                        <div class="d-flex justify-content-between ">
                                            <div class="d-flex justify-content-start align-items-center gap-1">
                                            <div class="rounded-circle  text-white fw-bold
                                        d-flex align-items-center justify-content-center"
                                                 style=" background:#2c3e50;width:36px;height:36px;flex-shrink:0;">
                                                @GetInitials(c.CreatedByUserName)
                                            </div>
                                          
                                            <strong>@c.CreatedByUserName</strong>

                                            </div>

                                           
                                                @* <button type="button"
                                                        class="btn btn-sm btn-light"
                                                        title="Delete"
                                                        @onclick="() => DeleteCommentAsync(c.Id)"
                                                        @onclick:stopPropagation
                                                        @onmousedown:stopPropagation>
                                                    <i class="bi bi-x-lg text-danger"></i>
                                                </button> *@
                                                  <div class="d-flex justify-content-end gap-2 mt-1">
        <!-- INLINE EDIT ICON -->
                                        <button type="button" class="btn btn-sm btn-light"
                                            title="Edit"
                                               @onclick="() => StartEditComment(c)"
                                               @onclick:stopPropagation
                                               @onmousedown:stopPropagation>
                                             <i class="bi bi-pencil"></i>
                                           </button>

        <!-- OPTIONAL: keep delete as small X -->
                                        <button type="button" class="btn btn-sm btn-light"
                                            title="Delete"
                                            @onclick="() => DeleteCommentAsync(c.Id)"
                                            @onclick:stopPropagation
                                            @onmousedown:stopPropagation>
                                                <i class="bi bi-x-lg text-danger"></i>
                                          </button>
                                          </div>
                                               
                                        </div>

                                          @if (editingCommentId == c.Id)
                                            {
                                                <textarea class="form-control mt-2"
                                                          rows="2"
                                                          @bind="editedCommentText"
                                                          @onclick:stopPropagation
                                                          @onmousedown:stopPropagation>
                                                </textarea>

                                                <div class="d-flex justify-content-end gap-2 mt-2">
                                                    <button class="btn btn-sm btn-secondary"
                                                            @onclick="CancelEditComment"
                                                            @onclick:stopPropagation>
                                                        Cancel
                                                    </button>

                                                    <button class="btn btn-sm savebtn"
                                                            @onclick="() => SaveEditedCommentAsync(c.Id)"
                                                            @onclick:stopPropagation>
                                                        Save
                                                    </button>
                                                </div>
                                            }
                                                else
                                                {
                                                  <p class="mb-0 mt-1">
                                                     @c.CommentText
                                                       </p>

  
                                                   }

                                        
                                            <div class="d-flex justify-content-end ">
                                               

                                                <small class="text-muted">
                                                @c.CreatedOn.ToLocalTime()
                                                
                                            </small>
                                            </div>

                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-muted small">
                                    No comments yet.
                                </div>
                            }
                            </div>
                        </div>
                        <div class="border rounded-3 p-3 mt-3 bg-light">
                            <textarea class="form-control mb-2"
                                      rows="2"
                                      placeholder="Write a comment..."
                                      @bind="newCommentText">
            </textarea>

                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm cmt-btn"
                                       
                                        @onclick="AddCommentAsync">
                                    <i class="bi bi-send me-1"></i> Add Comment
                                </button>
                            </div>
                           </div>
                        </div>
                       

                    <!-- RIGHT : col-4 -->
                    <div class="col-lg-4">

                        <!-- TASK DETAILS -->
                        @* <div class="card shadow-sm rounded-4 mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-info-circle me-2"></i>Task Details
                                </h6>

                                <div class="row small">
                                    <div class="col-6 text-muted">Created:</div>
                                    <div class="col-6 fw-semibold">May 3, 2023</div>

                                    <div class="col-6 text-muted mt-2">Updated:</div>
                                    <div class="col-6 fw-semibold mt-2">May 18, 2023</div>

                                    <div class="col-6 text-muted mt-2">Estimate:</div>
                                    <div class="col-6 fw-semibold mt-2">60 hrs</div>

                                    
                                </div>
                            </div>
                        </div> *@
                        @if (selectedTaskForDetails != null)
                        {
                            <div class="card shadow-sm rounded-4 mb-4">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3">
                                        <i class="bi bi-info-circle me-2"></i>Task Details
                                    </h6>

                                    <div class="row small">
                                        <div class="col-6 text-muted">CreatedOn:</div>
                                        <div class="col-6 fw-semibold">
                                            @selectedTaskForDetails.CreatedOn?.ToString("MMM dd, yyyy")
                                                                 

                                            
                                        </div>

                                        <div class="col-6 text-muted mt-2">Last UpdatedOn:</div>
                                        <div class="col-6 fw-semibold mt-2">
                                            @selectedTaskForDetails.LastUpdatedOn?.ToString("MMM dd, yyyy")
                                            
                                        </div>

                                        @* <div class="col-6 text-muted mt-2">Estimate:</div>
                                        <div class="col-6 fw-semibold mt-2">
                                            @(selectedTaskForDetails.EstimatedHours != null
                                                                                ? $"{selectedTaskForDetails.EstimatedHours} hrs"
                                                                                : "—")
                                        </div> *@
                                    </div>
                                </div>
                            </div>
                        }


                        <!-- PROJECT -->
                        @* <div class="card shadow-sm rounded-4 mb-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-folder me-2"></i>Project
                                </h6>

                                <p class="fw-semibold mb-1">@CurrentProject.Name</p>
                                <small class="text-muted">Backend Development</small>

                                <div class="mt-3">
                                    <span class="badge bg-secondary me-1">Backend</span>
                                    <span class="badge bg-secondary me-1">API</span>
                                    <span class="badge bg-secondary">Security</span>
                                </div>
                            </div>
                        </div> *@

                        <!-- PEOPLE -->
                        <div class="card shadow-sm rounded-4">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-people me-2"></i>People
                                </h6>

                                <!-- ASSIGNED TO -->
                                <div class="mb-4">
                                    <div class="fw-semibold text-muted small mb-2">
                                        Assigned To
                                    </div>

                                    @if (selectedTaskForDetails.TaskAssignments?.Any() == true)
                                    {
                                            <div class="row">
                                                @foreach (var a in selectedTaskForDetails.TaskAssignments)
                                                {
                                                    <div class="col-6 mb-2">
                                                        <div class="d-flex align-items-center">
                                                            <div class="rounded-circle text-white fw-bold
                                     d-flex align-items-center justify-content-center"
                                                                 style="background:#2c3e50;width:36px;height:36px;">
                                                                @GetInitials(a.AppUserName)
                                                            </div>

                                                            <div class="ms-3">
                                                                <div class="fw-semibold">@a.AppUserName</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">No members assigned</span>
                                        }
                                </div>

                                <hr />

                                <!-- CREATED BY -->
                                <div>
                                    <div class="fw-semibold text-muted small mb-2">
                                        Created By
                                    </div>

                                    @if (selectedTaskForDetails.TaskCreators!= null&&selectedTaskForDetails.TaskCreators.Any())
                                    {
                                        var creator = selectedTaskForDetails.TaskCreators.First();


                                      
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle  text-white fw-bold
                                                 d-flex align-items-center justify-content-center"
                                                 style=" background:#2c3e50;width:36px;height:36px;">
                                                    @GetInitials(creator.CreatedByUserName)
                                                </div>

                                                <div class="ms-3">
                                                    <div class="fw-semibold">@creator.CreatedByUserName</div>
                                                    
                                                </div>
                                            </div>
                                        }
                                      
                                    
                                    else
                                    {
                                        <span class="text-muted small">Creator not available</span>
                                    }
                                </div>
                            </div>
                        </div>


                    </div>

                </div>
            </div>
        </div>
    
    }
        </div>

        </div>
          

@code {
    private DashboardSummaryDto stats = new();
    private int memberId;
    private string search = "";
    private List<BoardDto> GroupedBoards = new();
    private TaskItemDto draggedTask;
    // private BoardDto draggedFromBoard;
    private string draggedFromBoardName = string.Empty;
    private TaskItemDto? selectedTaskForDetails;
    private bool showTaskDetailsModal = false;
    private bool isEditingDescription = false;
    private string editedDescription = "";
    private IBrowserFile? selectedAttachment;
    private TaskCommentDto newComment = new TaskCommentDto();
    private string newCommentText = string.Empty;
    private int editingCommentId = 0;
    private string editedCommentText = string.Empty;
    private List<MemberDto> members = new();
    private List<MemberDto> allMembers = new();

    private string ApiBaseUrl = "https://localhost:7218";


    protected override async Task OnInitializedAsync()
    {
        await LoadLoggedInUserId();
        await LoadDashboardStats();
        await LoadBoardsByUserAsync();
        // await LoadProjec();


    }
    //   private async Task LoadBoards()
    // {
    //     CurrentProject = await Http.GetFromJsonAsync<ProjectDto>($"api/Project/{ProjectId}");
    //     Boards = CurrentProject.Boards?.ToList() ?? new();
    // }
    private async Task LoadLoggedInUserId()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<UserInfoResponse>("api/Auth/me");

            memberId = result?.UserId ?? 0;
        }
        catch
        {
            memberId = 0;
        }
    }
    private async Task LoadDashboardStats()
    {
        if (memberId <= 0)
            return;

        var response = await Http.GetAsync($"api/Dashboard/SummaryForMember/{memberId}");

        if (response.IsSuccessStatusCode)
        {
            stats = await response.Content.ReadFromJsonAsync<DashboardSummaryDto>();
        }



    }
   
    private string GetFileUrl(string filePath)
    {
        if (string.IsNullOrWhiteSpace(filePath))
            return string.Empty;

        // If already absolute, return as-is
        if (filePath.StartsWith("http"))
            return filePath;

        return $"{ApiBaseUrl}{filePath}";
    }

    private async Task LoadBoardsByUserAsync()
    {
        if (memberId <= 0)
            return;
        var response = await Http.GetAsync($"api/Board/boards/user/{memberId}");
        if (response.IsSuccessStatusCode)
    {
            GroupedBoards = await response.Content.ReadFromJsonAsync<List<BoardDto>>() ?? new();
        }
    }
    string GetPriorityBorder(string? priority)
    {
        if (string.IsNullOrWhiteSpace(priority))
            return "priority-low";

        switch (priority.Trim().ToLowerInvariant())
        {
            case "low":
                return "priority-low-border";
            case "medium":
                return "priority-medium-border";
            case "high":
                return "priority-high-border";
            default:
                return "priority-low-border";
        }
    }


    private void OnTaskDragStart(DragEventArgs e, BoardDto fromBoard, TaskItemDto task)
    {

        draggedTask = task;
        draggedFromBoardName = fromBoard.Name;
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
            return string.Empty;

        return string.Join("", name.Split(' ', StringSplitOptions.RemoveEmptyEntries)
        .Select(n => n[0]))
        .ToUpper();
    }
    private void OnTaskDragOver(DragEventArgs e)
    {

    }

    // private async Task OnTaskDrop(DragEventArgs e, BoardDto toBoard, TaskItemDto targetTask)
    // {
    //     try
    //     {

    //         if (draggedTask == null || draggedFromBoard == null)
    //         {

    //             return;
    //         }

    //         if(draggedTask.ProjectId!=toBoard.ProjectId)
    //         {
    //             Console.WriteLine("cross-project drag blocked");
    //             draggedTask = null;
    //             draggedFromBoard = null;
    //             return;
    //         }
    //         var fromBoard = draggedFromBoard;


    //         var removeItem = fromBoard.TaskItems.FirstOrDefault(t => t.Id == draggedTask.Id);
    //         if (removeItem != null)
    //             fromBoard.TaskItems.Remove(removeItem);


    //         var list = toBoard.TaskItems
    //             .OrderBy(t => t.Order)
    //             .ToList();


    //         int targetIndex = list.FindIndex(t => t.Id == targetTask.Id);
    //         if (targetIndex < 0) targetIndex = list.Count;

    //         list.Insert(targetIndex, draggedTask);


    //         toBoard.TaskItems.Clear();
    //         foreach (var t in list)
    //             toBoard.TaskItems.Add(t);
    //         draggedTask.BoardId = toBoard.Id;

    //         if (toBoard.Name.Equals("Done", StringComparison.OrdinalIgnoreCase))
    //         {
    //             draggedTask.IsCompleted = true;
    //             draggedTask.CompletedDate = DateTime.Today;   
    //         }
    //         else
    //         {
    //             draggedTask.IsCompleted = false;
    //             draggedTask.CompletedDate = null; 
    //         }

    //         NormalizeOrder(fromBoard);

    //         NormalizeOrder(toBoard);

    //         await PersistBoardOrders(fromBoard);
    //         await PersistBoardOrders(toBoard);

    //         draggedTask = null;
    //         draggedFromBoard = null;
    //     }
    //     catch (Exception ex)
    //     {
    //         Console.WriteLine(ex.Message);
    //     }


    // }

    private async Task OnTaskDrop(
    DragEventArgs e,
    BoardDto visualBoard,
    TaskItemDto targetTask)
    {
        if (draggedTask == null)
            return;

        // 1️⃣ Remove from old VISUAL board
        var fromBoard = GroupedBoards
            .First(b => b.Name == draggedFromBoardName);

        fromBoard.TaskItems.Remove(draggedTask);

        // 2️⃣ Insert at correct position
        var ordered = visualBoard.TaskItems.ToList();

        int targetIndex = ordered.FindIndex(t => t.Id == targetTask.Id);

        if (targetIndex < 0)
            ordered.Add(draggedTask);
        else
            ordered.Insert(targetIndex, draggedTask);

        visualBoard.TaskItems.Clear();
        foreach (var t in ordered)
            visualBoard.TaskItems.Add(t);

        if (visualBoard.Name.Equals("Done", StringComparison.OrdinalIgnoreCase))
        {
            draggedTask.IsCompleted = true;
            draggedTask.CompletedDate ??= DateTime.UtcNow;
        }
        else
        {
            draggedTask.IsCompleted = false;
            draggedTask.CompletedDate = null;
        }

        NormalizeOrder(visualBoard);

        // 3️⃣ Persist (API resolves real board)
        await PersistBoardOrders(visualBoard);

        draggedTask = null;
    }


    private void NormalizeOrder(BoardDto board)
    {
        int order = 1;
        foreach (var t in board.TaskItems.OrderBy(t => t.Order))
        {
            t.Order = order++;
        }

    }


    // private async Task OnTaskDropToEmpty(DragEventArgs e, BoardDto toBoard)
    // {


    //     if (draggedTask == null)
    //     {

    //         return;
    //     }
    //     if(draggedTask.ProjectId!=toBoard.ProjectId)
    //     {
    //         Console.WriteLine("cross-project drag blocked");
    //         draggedTask = null;
    //         draggedFromBoard = null;
    //         return;
    //     }   

    //     var fromBoard = draggedFromBoard;
    //     if (fromBoard == null) return;


    //     var removeItem = fromBoard.TaskItems.FirstOrDefault(t => t.Id == draggedTask.Id);
    //     if (removeItem != null)
    //         fromBoard.TaskItems.Remove(removeItem);






    //     toBoard.TaskItems.Add(draggedTask);
    //     draggedTask.BoardId = toBoard.Id;

    //     if (toBoard.Name.Equals("Done", StringComparison.OrdinalIgnoreCase))
    //     {
    //         draggedTask.IsCompleted = true;
    //         draggedTask.CompletedDate = DateTime.Today;
    //     }
    //     else
    //     {
    //         draggedTask.IsCompleted = false;
    //         draggedTask.CompletedDate = null; 
    //     }



    //     NormalizeOrder(fromBoard);
    //     NormalizeOrder(toBoard);

    //     await PersistBoardOrders(fromBoard);
    //     await PersistBoardOrders(toBoard);

    //     draggedTask = null;
    //     draggedFromBoard = null;

    // }

    private async Task OnTaskDropToEmpty(
    DragEventArgs e,
    BoardDto visualBoard)
    {
        if (draggedTask == null)
            return;

        var fromBoard = GroupedBoards
            .First(b => b.Name == draggedFromBoardName);

        fromBoard.TaskItems.Remove(draggedTask);
        visualBoard.TaskItems.Add(draggedTask);


        if (visualBoard.Name.Equals("Done", StringComparison.OrdinalIgnoreCase))
        {
            draggedTask.IsCompleted = true;
            draggedTask.CompletedDate ??= DateTime.UtcNow;
        }
        else
        {
            draggedTask.IsCompleted = false;
            draggedTask.CompletedDate = null;
        }

        NormalizeOrder(visualBoard);

        await PersistBoardOrders(visualBoard);

        draggedTask = null;
    }

    private async Task PersistBoardOrders(BoardDto board)
    {
        bool isDoneBoard =
           board.Name.Equals("Done", StringComparison.OrdinalIgnoreCase);
        var payload = board.TaskItems.Select(t => new TaskReorderForMembersDto
        {
            TaskId = t.Id,
            TargetBoardName = board.Name,
            Order = t.Order,
         
        }).ToList();

        await Http.PutAsJsonAsync("api/TaskItem/tasksformembers/reorder", payload);
        await LoadDashboardStats();
        
    }
   
   
    private string GetPriorityBadgeClass(string? priority)
    {
        return priority?.ToLowerInvariant() switch
        {
            "low" => "bg-success text-white",
            "medium" => "bg-warning text-dark",
            "high" => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }
    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "todo" => "bg-secondary text-white",
            "in progress" => "bg-primary text-white",
            "done" => "bg-success text-white",
            "review" => "bg-warning text-dark",
            _ => "bg-info text-dark"
        };
    }
    // private async Task OnAttachmentSelected(InputFileChangeEventArgs e)
    // {
    //     if (selectedTaskForDetails == null)
    //         return;

    //     selectedAttachment = e.File;

    //     var content = new MultipartFormDataContent();

    //     var streamContent = new StreamContent(
    //         selectedAttachment.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024));

    //     streamContent.Headers.ContentType =
    //         new System.Net.Http.Headers.MediaTypeHeaderValue(selectedAttachment.ContentType);

    //     content.Add(streamContent, "File", selectedAttachment.Name);



    //     var response = await Http.PostAsync(
    //         $"api/FileAndCommentInTask/{selectedTaskForDetails.Id}/attachments",
    //         content
    //     );



    //     if (response.IsSuccessStatusCode)
    //     {
    //         var newAttachment =
    //             await response.Content.ReadFromJsonAsync<TaskAttachmentDto>();

    //         if (newAttachment != null)
    //         {
    //             Console.WriteLine("Attachment uploaded: " + newAttachment.FilePath);
    //             selectedTaskForDetails.TaskAttachments ??= new List<TaskAttachmentDto>();
    //             selectedTaskForDetails.TaskAttachments.Add(newAttachment);
    //         }

    //         StateHasChanged();

    //         await OpenTaskDetailsAsync(selectedTaskForDetails.Id);
    //     }
    //     else
    //     {
    //         var error = await response.Content.ReadAsStringAsync();
    //         Console.WriteLine("Upload failed: " + error);
    //     }
    // }
 
    private async Task AddCommentAsync()
    {
        if (string.IsNullOrWhiteSpace(newCommentText))
            return;

        var dto = new TaskCommentDto
        {
            CommentText = newCommentText,

        };

        var response = await Http.PostAsJsonAsync(
        $"api/FileAndCommentInTask/{selectedTaskForDetails.Id}/comments",
        dto
        );

        if (response.IsSuccessStatusCode)
        {
            newCommentText = string.Empty;

            // 🔁 Refresh task details (comments included)
            await OpenTaskDetailsAsync(selectedTaskForDetails.Id);
        }
    }
    private void StartEditComment(TaskCommentDto comment)
    {
        editingCommentId = comment.Id;
        editedCommentText = comment.CommentText;
    }

    private void CancelEditComment()
    {
        editingCommentId = 0;
        editedCommentText = string.Empty;
    }
    private async Task SaveEditedCommentAsync(int commentId)
    {
        if (string.IsNullOrWhiteSpace(editedCommentText))
            return;

        var dto = new TaskCommentDto
        {
            CommentText = editedCommentText
        };

        var response = await Http.PutAsJsonAsync(
            $"api/FileAndCommentInTask/comments/{commentId}",
            dto
        );

        if (response.IsSuccessStatusCode)
        {
            editingCommentId = 0;
            editedCommentText = string.Empty;


            await OpenTaskDetailsAsync(selectedTaskForDetails.Id);
        }
        else
        {
            Console.WriteLine("Failed to update comment");
        }
    }
    private async Task DeleteCommentAsync(int commentId)
    {
        var response = await Http.DeleteAsync(
            $"api/FileAndCommentInTask/comments/{commentId}"
        );

        if (response.IsSuccessStatusCode)
        {
            await OpenTaskDetailsAsync(selectedTaskForDetails.Id);
        }
        else
        {
            Console.WriteLine("Failed to delete comment");
        }
    }


    private async Task OpenTaskDetailsAsync(int taskId)
    {
        try
        {
            var response = await Http.GetAsync($"api/FileAndCommentInTask/{taskId}");
            if (response.IsSuccessStatusCode)
            {
                selectedTaskForDetails = await response.Content.ReadFromJsonAsync<TaskItemDto>();



                if (selectedTaskForDetails != null)
                {
                    showTaskDetailsModal = true;
                }
            }
            else
            {
                Console.WriteLine("Failed to fetch task details.");
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine("Error fetching task details: " + ex.Message);
        }
    }
  
    private class UserInfoResponse
    {
        public int UserId { get; set; }
    }
    private void CloseTaskDetails()
    {
        showTaskDetailsModal = false;
        selectedTaskForDetails = null;
    }


}
